<h1>Harvest Report</h1>

<p>This page is a <i>mockup</i> of a simplified harvest report.</p>

<div v-cloak id="harvestReport">
    <label for="title">Title: </label>
    <input type="text" id="title" name="title" v-model="title" />

    <br /><br />

    <label for="start">Start: </label>
    <input
        type="date"
        id="start"
        name="start"
        min="2014-01-01"
        max="2022-01-01"
        :max="endDate"
        v-model="startDate"
    />

    <label for="end">End: </label>
    <input
        type="date"
        id="end"
        name="end"
        min="2014-01-01"
        :min="startDate"
        max="2022-01-01"
        v-model="endDate"
    />

    <br /><br />

    <label for="crop">Crop: </label>
    <select id="crop" name="crop">
        <option v-for="selCrop in cropMapToArray">{{ selCrop }}</option>
    </select>

    <label for="field">Field: </label>
    <select id="field" name="field">
        <option v-for="field in fieldMapToArray">{{ field }}</option>
    </select>

    <br /><br />

    <button type="button" @click="generateReport">Generate Report</button>

    <hr />

    <h1>{{ title == '' ? 'Mock Harvest Report' : title }}</h1>

    <p>Details:</p>

    <ul>
        <li><strong>Farm: </strong>{{ farmInfo.name }}</li>
        <li><strong>User: </strong>{{ farmInfo.user }}</li>
        <li><strong>Language: </strong>{{ farmInfo.language }}</li>
        <br />
        <li><strong>Start: </strong>{{ startDate }}</li>
        <li><strong>End: </strong>{{ endDate }}</li>
        <li><strong>Crop: </strong>{{ crop }}</li>
    </ul>

    <table v-if="harvestReportRows != ''" border="1">
        <tr>
            <th>Row</th>
            <th>Date</th>
            <th>Area</th>
            <th>Crop</th>
            <th>Yield</th>
            <th>Units</th>
        </tr>
        <tr v-for="(log,index) in harvestReportRows">
            <td>{{index + 1}}</td>
            <td>{{log.date}}</td>
            <td>{{log.area}}</td>
            <td>{{log.crop}}</td>
            <td>{{log.yield}}</td>
            <td>{{log.units}}</td>
        </tr>
    </table>
    <p v-else>No logs found.</p>

    <button type="button" @click="">Export CSV</button>
</div>

<script>
    var harvestReport = new Vue({
        created() {
            getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap = theMap;
                })
                .catch((err) => {
                    console.log('Error occurred in getIDToCropMap()');
                    console.log(err);
                });
            getIDToAreaMap()
                .then((theMap2) => {
                    this.idToFieldMap = theMap2;
                })
                .catch((err) => {
                    console.log('Error occured in getIDToAreaMap()');
                    console.log(err);
                });
        },
        el: '#harvestReport',
        data: {
            title: 'My Sample Harvest Report',
            startDate: '2020-05-05',
            endDate: '2020-05-15',
            crop: 'Kale',
            logs: [],
            newLog: {
                date: '2018-05-01',
                area: 'Orion-3',
                crop: 'Kale',
                yield: 12,
                units: 'Bunches',
            },
            farmInfo: {
                name: '',
                user: '',
                language: '',
            },
            defFarmInfo: {
                name: 'Sample Farm',
                user: 'manager1',
                language: 'English',
            },
            idToCropMap: [],
            idToFieldMap: [],
            startDateUnix: '',
            endDateUnix: '',
            dateRequest: '',
            datePages: [],
        },
        computed: {
            cropMapToArray: function () {
                return ['All'].concat(Array.from(this.idToCropMap.values()));
            },
            fieldMapToArray: function () {
                return ['All'].concat(Array.from(this.idToFieldMap.values()));
            },
            harvestReportRows() {
                let tableRows = []
                for(let log of this.datePages) {
                    let tableRow = {
                        date: dayjs.unix('' + log.timestamp + '').format('YYYY-MM-DD'),
                        area: log.area[0].name,
                        crop: this.idToCropMap.get(log.data.crop_tid),
                        yield: log.quantity[0].value,
                        units: log.quantity[0].unit.name,
                    }
                    tableRows.push(tableRow)
                }
                return tableRows
            }
        },
        methods: {
            generateReport: function () {
                axios
                    .get('/farm.json')
                    .then((response) => {
                        console.log('Got Response');
                        console.log(response);
                        this.farmInfo.name = response.data.name;
                        this.farmInfo.user = response.data.user.name;
                        this.farmInfo.language =
                            response.data.languages.en.name;
                    })
                    .catch((error) => {
                        console.log('Error Occurred');
                        console.log(error);
                    });
                if (this.newLog != '') {
                    this.logs.push(this.newLog);
                }
                this.newLog = '';
                this.farmInfo = this.defFarmInfo;
                this.startDateUnix = dayjs(this.startDate).unix();
                this.endDateUnix = dayjs(this.endDate).unix();
                this.dateRequest =
                    '/log.json?type=farm_harvest&timestamp[ge]=' +
                    this.startDateUnix +
                    '&timestamp[le]=' +
                    this.endDateUnix;
                this.datePages = '',
                getAllPages('' + this.dateRequest + '')
                    .then((res) => {
                        this.datePages = res;
                    })
                    .catch((err) => {
                        console.log(err);
                        console.log(
                            'Error in getAllPages.'
                        );
                    });
            },
        },
    });
    Vue.config.devtools = true;
</script>
