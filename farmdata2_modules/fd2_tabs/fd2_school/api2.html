<!DOCTYPE html>
<html>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<div id="harvestReport" style="[v-cloak] {display:none;}">
    <!-- PAGE HEADER -->
    <h1>Harvest Report</h1>
    <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
    <!-- REPORT TITLE INPUT -->
    <label for="reportTitle"> Title:</label>
    <input type="text" id="reportTitle" name="reportTitle" v-model="header">
    <br></br>
    <!-- REPORT START DATE INPUT -->
    <label for="reportStartDate">Start:</label>
    <input type="Date" name="reportStartDate" id="reportStartDate" min="2014-01-01" :max="reportEndDate" v-model="reportStartDate">
    <!-- REPORT END DATE INPUT -->
    <label for="reportEndDate">End:</label>
    <input type="Date" id="reportEndDate" name="reportEndDate" :min="reportStartDate" max="2022-01-01" v-model="reportEndDate">
    <br></br>
    <!-- CROP INPUT -->
    <label for="crop">Crop:</label>
    <select id="crop" name="crop" v-model="selectedCrop">
        <option v-for="crop in cropMapToArray">{{ crop }}</option>
    </select>
    <!-- FIELD INPUT -->
    <label for="Field">Field:</label>
    <select id="Field" name="Field" v-model="selectedField">
        <option v-for="field in areaMapToArray">{{ field }}</option>
    </select>
    <br></br>
    <!-- GENERATE REPORT BUTTON -->
    <input type="button" value="Generate Report" @click="generateData();">
    <hr>
    </hr>
    <!-- REPORT TITLE -->
    <h1>{{header ? header : "Mock Harvest Report"}}</h1>
    <!-- REPORT DETAILS -->
    <p>Details:</p>
    <ul>
        <li><strong>Farm</strong>: {{ farm }}</li>
        <li><strong>User</strong>: {{ user }}</li>
        <li><strong>Language</strong>: {{ language }}</li>
    </ul>
    <ul>
        <li><strong>Start</strong>: {{reportStartDate}}</li>
        <li><strong>End</strong>: {{reportEndDate}}</li>
        <li><strong>Crop</strong>: {{ selectedCrop }}</li>
    </ul>
    <!-- HARVEST LOG TABLE -->
    <table border="1" v-if="harvestLog.length != 0">
        <p v-if="harvestLog.length == 0">No matching records</p>
        <tr>
            <th>Row</th>
            <th>Date</th>
            <th>Area</th>
            <th>Crop</th>
            <th>Yeild</th>
            <th>Units</th>
            <th>Delete</th>
        </tr>
        <tr v-for="(log, index) in harvestReportRows">
            <td>{{ index }}</td>
            <td>{{ log.date }}</td>
            <td>{{ log.area }}</td>
            <td>{{ log.crop }}</td>
            <td>{{ log.yeild }}</td>
            <td>{{ log.units }}</td>
            <td><button type="button" @click='deleteLog'>Delete</button></td>
        </tr>
    </table>
</div>
<script>
var harvestReport = new Vue({
    el: '#harvestReport  ',
    computed: {
        cropMapToArray(){
            return Array.from(this.idToCropMap.values());
        },
        areaMapToArray(){
            return Array.from(this.idToAreaMap.values());
        },
        harestReportRows(){
            let tableRows = []
            for (let log of this.harvestLog){
                let tableRow = {
                    date: log.timestamp,
                    area: log.area[0].name,
                    crop: this.idToCropMap.get(log.data.crop_tid),
                    yield: log.quantity[0].value,
                    units: log.quantity[0].unit.name,
                    
                }
                tableRows.push(tableRow)
            }
            return tableRows
        }

    },
    created(){
        getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap;
            })
            .catch((err) => {
                console.log("Error getting CropMap");
            })
        getIDToAreaMap()
            .then((theMap) => {
                this.idToAreaMap = theMap;
            })
            .catch((err) => {
                console.log("Error getting AreaMap");
            })
    },
    data: {
        farm: '',
        user:'',
        language:'',

        header: 'My Sample Harvest Report',

        reportStartDate: '2020-05-05',
        reportEndDate: '2022-05-15',

        selectedCrop: 'Kale',
        selectedField: 'All',

        harvestLog: [],

        someHarvestLogs: {
            firstLog: {
                date: '2018-05-02',
                area: 'Chuau-1',
                crop: 'Kale',
                'yeild': 10,
                units: 'Bunches'
            },
            secondLog: {
                date: '2020-08-01',
                area: 'SQ7',
                crop: 'Broccoli',
                'yeild': 15,
                units: 'Pounds' }
        },

        idToCropMap: [],
        idToAreaMap: [],
    },
    methods: {
        //saveLog: function(){
          //  this.harvestLog.push(this.someHarvestLogs.firstLog);
        //},
        deleteLog: function(logIndex){
            this.harvestLog.splice(this.logIndex, 1);
        },
        generateData: function(){
            
            axios
                .get('/farm.json')
                .then((response)=>{
                    console.log("Got Response");
                    console.log(response);

                    this.farm = response.data.name;
                    this.user = response.data.user.name;
                    this.language = response.data.user.language

                })
                .catch((error) => {
                    console.log("Error Occured");
                    console.log(error);
                });

            let startTime = dayjs(this.reportStartDate).unix();
            let endTime = dayjs(this.reportEndDate).unix();
            let logRequest = ('/log.json?type=farm_harvest&timestamp[ge]' +startTime + '&timestamp[le]' + endTime);

            console.log(startTime);
            console.log(endTime);
            console.log(logRequest);

            
            getAllPages(logRequest)
                .then((result) => {
                    this.harvestLog = result;
                    console.log("logs Added");
                })
                .catch((error) => {
                    console.log("Cannot fetch log");
                    console.log(error);
                });
                

        }
    }
});
Vue.config.devtools = true
</script>
</html>

