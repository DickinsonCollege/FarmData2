<!DOCTYPE html>
<html>
	<head>
        <div id="harvest-report">
        <meta charset="utf-8">
        <body>
		<h1>Harvest Report</h1>
			<p>This page is a <i>mockup</i> of a simplified harvest report.</p>
            <label for="title">Title:</label>
            <input type="text" v-model="header" placeholder="My Sample Harvest Report"><br><br>
            
            
            <label for="startDate">Start: </label>
            <input v-model="startDate" type="date" min="2014-01-01" max="2022-01-01" :max="endDate">
			
            <label for="endDate">    End: </label>
            <input v-model="endDate" type="date" min="2014-01-01" max="2022-01-01" :min="startDate">
            
            <br>
            
            
            <br>
            
			<label for="cropDropDown">Crop: </label>
			<select v-model="cropSelect" name="crops">
                <option v-for="cropNameArrs in cropNameArr"> {{ cropNameArrs }} </option>
				
			</select>  
            
            <label for="fieldDropDown">Area: </label>
            <select v-model="fieldSelect" name="fieldsss">
                <option v-for="areaNameArrs in areaNameArr"> {{ areaNameArrs }} </option>
            
            </select>
            
            <br>
            
            
            <br>
            
            <button class="btn btn-primary" @click="addLog">Generate Report</button>
			<h1>{{ header.length == 0 ? "Mock Harvest Report" : header }}</h1>
				<p>Details:</p>
					<ul>
                        <li><strong>Farm: </strong>{{ Farm }}</li>
						<li><strong>User: </strong>{{ User }}</li>
						<li><strong>Language: </strong>{{ Language }}</li><br>
						<li><strong>Start: </strong>{{ startDate }}</li>
                        <li><strong>End: </strong>{{ endDate }}</li>
                        <li><strong>Crop: </strong>{{ cropSelect }}</li>
                                            </ul>
			<table border=2>
				<tr v-if= "harLogsArr.length > 0">
                    <td><strong> Row </strong></td>
					<td><strong> Date </strong></td>
					<td><strong> Area </strong></td>
					<td><strong> Crop </strong></td>
					<td><strong> Yield </strong></td>
					<td><strong> Units </strong></td>
				</tr>
					<tr v-for="(log, index) in harvestReportRows">
                     
                        
                        <td> {{ index + 1 }}</td>

					<td> {{ log.date }} </td>
					<td> {{ log.area }} </td>
					<td> {{ log.crop }} </td>
					<td> {{ log.yield }} </td>
                    <td> {{ log.units }} </td>
                    
                    </tr>
              </table>

             

              </body>
              </div>

              <script>
                  var harvestReport = new Vue ({
                    el: '#harvest-report',
                    data: {
                    header: '',
                    Farm: '',
                    User: '',
                    Language: '',
                    startDate: '2020-05-05',
                    endDate: '2020-05-15',
                    cropSelect: 'Kale',
                    fieldSelect: 'All',
                    field: ['All', 'Chuau-1', 'SQ7'],
                    pageDate: [],
                    cropMap: [],
                    areaMap: [],
                    harLogsArr: [],
                    harvestLog:[
                       
                    ],
                        row: 
                         {date: '05/01/2018', field: 'Orion-3', crop: 'Kale', yield: '12', units: 'Bunches'},
                    },

                    created() {
                    console.log("HarvestReport created!");
                    getIDToCropMap()
                    .then((theMap) => {
                            A:  console.log("Got Response: getIDToCropMap success");
                                console.log(theMap);
                                this.cropMap = theMap;
                    }
                    )
                    .catch((err) => {
                            B:  console.log("Error Occurred: getIDToCropMap failed");
                                console.log(err);
                    }),

                    getIDToAreaMap()
                    .then((getAreaMap) => {
                            A:  console.log("Got Response: getIDToAreaMap success");
                                console.log(getAreaMap);
                                this.areaMap = getAreaMap;
                    })
                    .catch((err) => {
                            B:  console.log("Error Occurred: getIDToAreapMap failed");
                                console.log(err);
                    })
                  },

                computed: {
                    cropNameArr(){
                        return Array.from(this.cropMap.values());
                    },

                    areaNameArr(){
                        return Array.from(this.areaMap.values());
                    },

                    harvestReportRows() {
	                let tableRows = []
	                for(let log of this.pageDate) {
		            let tableRow = {
                        date: log.timestamp,
                        area: log.area[0].name,
                        crop: this.cropMap.get(log.data.crop_tid),
                        yield: log.quantity[0].value,
                        units: log.quantity[0].unit.name,

		            }
                        tableRows.push(tableRow)
                }
                    return tableRows}

                },
                    methods: {
                        addLog:function(){
                            axios.get('/farm.json')
                        .then((response) => {
                            A:  console.log("Got Response");
                                console.log(response);
                                this.Farm=response.data.name;
                                this.User=response.data.user.name;
                                this.Language=response.data.user.language;

                        })
                        .catch((error) => {
                            B:  console.log("Error Occurred");
                                console.log(response);
                        })
                        C:  this.harvestLog.push(this.row);
                        let startDate_timestamp = dayjs(this.startDate).unix();
                        let endDate_timestamp = dayjs(this.endDate).unix();
                        console.log(startDate_timestamp);
                        console.log(endDate_timestamp);
                        dateAPIStr = '/log.json?type=farm_harvest&timestamp[ge]=' + startDate_timestamp + '&timestamp[le]=' + endDate_timestamp;
                        console.log(dateAPIStr);

                        this.pageDate = '',
                        getAllPages(dateAPIStr, this.harLogsArr)
                        .then((result) => {
                        console.log('getAllPages request completed successfully')
                        this.pageDate = result;
                    })
                        .catch((err) => {
                        console.log('getAllPages request failed');
                        console.log(err);
                        })
                      },
                  }
                  }
                  );

                  Vue.config.devtools = true;
              </script>
	</head>
</html>