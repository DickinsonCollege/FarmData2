<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>My test page</title>
  </head>
  <body>
    <div id="report" v-cloak>
        <input type="text" v-model="reportTitle">
    
        <h1>Harvest Report</h1>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>

        <label for="title">Title:</label>

        <input type="text" id="title" value="My sample harvest report">
        <br>

        <!-- value="2020-05-05" -->
        <label for="start">Start:</label>
        <input id="start" 
                type="date"
                v-model="reportStartDate"
                min="2014-01-01"
                v-bind:max="reportEndDate"
                >
                <!-- max="2022-01-01" -->
        
        <!-- value="2020-05-15" -->
        <label for="end">End:</label>
        <input id="end" 
                type="date"
                v-model="reportEndDate"
                v-bind:min="reportStartDate"
                max="2022-01-01">
        <!-- min="2020-05-05" -->
        <br>

        <label for="crop">Crop:</label>
        <select id="crop" v-model="reportCrop">
            <option v-for="crop in mapCropToArray">{{ crop }}</option>
        </select>    

        <label for="field">Field:</label>
        <select id="field" v-model="reportField">
            <option v-for="field in mapAreaToArray">{{ field }}</option>
        </select> 
        <br>

        <button v-on:click='this.getPages'>Generate Report</button>

        <hr/>

        <h1>{{ reportTitle ? reportTitle : 'Mock Harvest Report' }}</h1>
    
        <p>Details:</p>
        <ul> 
            <li v-model="farm"><strong>Farm: </strong>{{ farm }}</li>
            <li v-model="user"><strong>User: </strong>{{ user }}</li>
            <li v-model="language"><strong>Language: </strong>{{ language }}</li>
            <br/>
            <li><strong>Start:</strong>{{ reportStartDate }}</li>
            <li><strong>End:</strong>{{ reportEndDate }}</li>
            <li><strong>Crop:</strong>{{ reportCrop }}</li>
        </ul>

        <p v-if="logs.length === 0">No matching records found</p>
        <table v-else border=1>
            <tr>
                <th>Row</th>
                <th>Date</th>
                <th>Area</th>
                <th>Crop</th>
                <th>Yield</th>
                <th>Unit</th>
            </tr>
            <tr v-for="(log, index) in logs">
                <td>{{ index + 1}}</td>
                <td>{{ log.date }}</td>
                <td>{{ log.area }}</td>
                <td>{{ log.crop }}</td>
                <td>{{ log.yield }}</td>
                <td>{{ log.units }}</td>
            </tr>
            </tr>
        </table>
    </div>
    <script>
        Vue.config.devtools = true;
        var report = new Vue ({
            el: '#report',
            created() {
                console.log("HarvestReport created!");
                getIDToCropMap()        
                .then((theMap) => {
                    this.idToCropMap = theMap;
                    console.log(theMap);
                })
                .catch((err) => {
                    console.log(err);
                })

                getIDToAreaMap()
                .then((theMap) => {
                    this.idToAreaMap = theMap;
                    console.log(theMap);
                })
                .catch((err) => {
                    console.log(err);
                })

            },
            data: {
                reportTitle: 'My Sample Harvest Report',
                reportStartDate: '2020-05-05',
                reportEndDate: '2020-05-15',
                reportCrop: 'Kale',
                reportField: 'All',
                logs: [
                    // {date: '2018-05-02', area: 'Chuau-1', crop: 'Kale', 'yield': 10, units: 'Bunches'},
                    // {date: '2018-05-05', area: 'SQ7', crop: 'Kale', 'yield': 7, units: 'Bunches'}
                ],
                farm: '',
                user: '',
                language: '',
                idToCropMap: [],
                idToAreaMap: [],
                pageResult: [],
            },
            computed: {
                mapCropToArray() {
                    return Array.from(this.idToCropMap.values());
                },
                mapAreaToArray() {
                    return Array.from(this.idToAreaMap.values());
                }
            },
            methods: {
                getPages: function() {
                    let t1 = dayjs(this.reportStartDate).unix();
                    let t2 = dayjs(this.reportEndDate).unix();

                    getAllPages('/log.json?type=farm_harvest&timestamp[ge]=' + t1 + '&timestamp[le]=' + t2, this.pageResult)
                    .then(() => {
                        console.log('success')
                    })
                    .catch((err) => {
                        console.log(err);
                    })
                    console.log(this.pageResult);
                },
                // convertTimestamp: function() {
                    // let t1 = dayjs(this.reportStartDate).unix();
                    // let t2 = dayjs(this.reportEndDate).unix();
                    // console.log(t1);
                    // console.log(t2);

                    // const request = "/log.json?type=farm_harvest&timestamp[ge]=" + t1 + "&timestamp[le]=" + t2;
                    // console.log(request);
                // },
                addLog: function() {
                    axios.get('http://localhost/farm.json')
                        .then((response) => {
                            console.log("Got Response");
                            console.log(response);
                            res = response.data;
                            this.farm = res.name;
                            this.user = res.user.name;
                            this.language = res.languages.en.name; 
                        })
                        .catch((error) => {
                            console.log("Error Occurred");
                            console.log(error);
                        }) 

                    const n = this.logs.length;
                    if (n == 0){
                      this.logs.push({date: '05/05/2018', area: 'Orion-1', crop: 'Kale', yield: 12, units: 'Bunches'});
                    }
                    else if (n == 1){
                      this.logs.push({date: '06/01/2019', area: 'Orion-2', crop: 'Pea', yield: 120, units: 'Bunches'});
                    }
                    else if (n == 2) {
                      this.logs.push({date: '05/07/2021', area: 'Orion-3', crop: 'Carrot', yield: 10, units: 'Bunches'});
                    }
                }
            }
        });
    </script> 
  </body>
</html>
