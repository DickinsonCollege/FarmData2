<!DOCTYPE html>
<html lang="en">
    <head></head>
    <body>
        <h1 class="text-center">Harvest Report</h1>
            <div id="rpt" class = "v-cloak">
                    <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 50%;">
                        <legend class="panel-heading fd2-legend">
                             <center>Date Span</center>
                        </legend>
                        <div class="center-block">
                            <div style="display: flex;width: 100%; padding: 7px">
                                <date-range-selection 
                                    class="center-block"  
                                    :default-start-date=startDate :default-end-date=endDate
                                    @start-date-changed='startDateChange'
                                    @end-date-changed='endDateChange' 
                                    @click='hide'>
                                </date-range-selection>
                            <button class="btn center-block btn-primary" v-if='!reportVisible' @click='harvestLogRequestInDateSpan'>Run Date Filter</button>
                            </div>
                        </div>
                    </fieldset>

                <div v-if='reportVisible'>    
                    <div v-if="harvestLogs.length != 0">
                        <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 75%;">              
                            <legend class="panel-heading fd2-legend">
                                <center>Filters</center>
                            </legend>            
                            <div style="display: flex;width: 100%; padding: 7px">
                                <dropdown-with-all class="center-block" :dropdown-list=cropList includes-all default-input='All' @selection-changed='cropChange'>Crop:</dropdown-with-all>
                                <dropdown-with-all class="center-block" :dropdown-list=fieldList includes-all default-input='All' @selection-changed='fieldChange'>Field:</dropdown-with-all> 
                            </div>
                        </fieldset>
                    
                        <custom-table 
                            can-delete 
                            can-edit
                            :headers="tableHeaders" 
                            :input-options="tableInputTypes"
                            :rows="tableData"
                            :visible-columns="tableVisibleColumns"  
                            @row-deleted="deleteTableRow"
                            @row-edited="updateTableRow"
                            @edit-clicked='disableFilters' 
                            @row-canceled='enableFilters'>
                        </custom-table>
                    </div>
                    <div class="loader center-block" v-if="stillLoading"></div>
                    <div v-if="!stillLoading && harvestLogs.length == 0">
                        <div class="box" data-cy="no-logs-message" style="  
                            border: 5px solid #d62a17;
                            background-color: white;
                            padding: 20px;
                            margin: auto;
                            width: 50%;
                            text-align: center;
                            font-size: large;">
                            No Logs Found in These Dates 
                        </div> 
                    </div>
                </div>
            </div>    
                        
                        
       
       <script>
           var ReportVue= new Vue({
                el:"#rpt",
                components: {
                    'dropdown-with-all': DropdownWithAllComponent,
                    'date-range-selection': DateRangeSelectionComponent,
                    'custom-table': CustomTableComponent,
                },
                data:{
                    //Data upon initialization
                    sessionToken: null,
                    
                    startDate: dayjs().format('YYYY-MM-DD').toString(),
                    endDate: dayjs().format('YYYY-MM-DD').toString(),  
                
                    chosenCrop:"All",
                    chosenField:"All",
                    
                    
                    rowBeingEdited : false,
                    reportVisible: false,
                    
                    //Processing data segment
                    stillLoading: true,
                    harvestLogs:[],
                    updateLog:[],
                    Farm:"",
                    User:"",
                    Language:"",

                    idToCropMap: new Map(),
                    cropToIDMap: new Map(),
                    idToUserMap: new Map(),
                    userToIDMap: new Map(),
                    areaToIDMap: new Map(),
                    unitToIDMap: new Map(),

                    tableHeaders: [ 'Date', 'Crop', 'Field', 'Yield', 'Unit', 'Hours','Comments', 'Users', 'Edit', 'Delete'],
                    tableVisibleColumns:[true, true, true, true, true, true, true, true],

                },
                methods: {
                    hide(){
                        this.reportVisible = false
                        this.harvestLogs = []
                    },
                    startDateChange(newDate) {
                            this.startDate = newDate
                        },
                    endDateChange(newDate) {
                            this.endDate = newDate
                        },    
                    cropChange(selectedCrop) {
                            this.chosenCrop = selectedCrop
                        },
                    fieldChange(selectedField) {
                            this.chosenField = selectedField
                        },
                    harvestLogRequestInDateSpan(){
                            this.reportVisible = true
                            let link = '/log.json?type=farm_harvest&timestamp[ge]=' + dayjs(this.startDate).unix() + '&timestamp[le]=' + dayjs(this.endDate).unix()
                            getAllPages(link,this.harvestLogs).then(()=>{
                                this.stillLoading = false
                            })
                            this.stillLoading = true
                    },    
                    
                    deleteTableRow(logID) {
                        let url = '/log/' + logID
                        deleteRecord(url, this.sessionToken)
                        for(var i = 0; i < this.harvestLogs.length; i++){
                            if(this.harvestLogs[i].id === logID){
                                this.harvestLogs.splice(i, 1)
                            }
                        }
                    },
                    updateTableRow(edits, rowID) {
                        for(var i = 0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                for( const [key, value] of Object.entries(edits)) {
                                    this.tableData[key] = value
                                }
                            }
                        }

                        // Would also need to update data in the db via API here.
                    },
                    
                    disableFilters() {
                        this.rowBeingEdited = true
                    },
                    enableFilters(){
                        this.rowBeingEdited = false
                    },
                },
                computed:{
                    cropList(){
                        let harvestFilter = this.harvestLogs.filter((log) => log)
                        let cropArray = []
                        if(this.chosenField != 'All') {
                            let fieldFilter = harvestFilter.filter((log) => log.area[0].name === this.chosenField)
                            cropArray = fieldFilter.map(log => 
                                this.idToCropMap.get(log.data.crop_tid)
                            )
                        }
                        else {
                            cropArray = harvestFilter.map((log) => this.idToCropMap.get(log.data.crop_tid))
                        }

                        let crops = new Set(cropArray)
                        let newCropArray = Array.from(crops)
                        return newCropArray.sort()
                    },
                    fieldList(){
                        let harvestFilter = this.harvestLogs.filter((log) => log)
                        let fieldArray = []
                        if(this.chosenCrop != 'All'){
                            let cropFilter = harvestFilter.filter((log) => this.idToCropMap.get(log.data.crop_tid) === this.chosenCrop)
                            fieldArray = cropFilter.map(log =>
                                log.area[0].name
                            )
                        }
                        else{
                            fieldArray = harvestFilter.map(log =>
                                log.area[0].name
                            )
                        }
                        let fields = new Set(fieldArray)
                        let newfieldArray = Array.from(fields)
                        return newfieldArray.sort()
                    },
                    tableData() {
                        let filterRows = this.harvestLogs.filter((log) => log)

                        if(this.chosenField != 'All'){
                            filterRows = filterRows.filter((log) => log.area[0].name === this.chosenField)
                        }
                        if(this.chosenCrop != 'All'){
                            filterRows = filterRows.filter((log) => this.idToCropMap.get(log.data.crop_tid) === this.chosenCrop)
                        }
                        let $vm = this
                        let rows = filterRows.map(function(harvestLog) {
                            return{
                                id: harvestLog.id,
                                data: [
                                    dayjs.unix(harvestLog.timestamp).format('YYYY-MM-DD'),
                                    $vm.idToCropMap.get(harvestLog.data.crop_tid),
                                    harvestLog.area[0].name, 
                                    harvestLog.quantity[0].value,
                                    harvestLog.quantity[0].unit.name,
                                    (Math.round(harvestLog.quantity[1].value*100))/100,
                                    harvestLog.notes.value,
                                    $vm.idToUserMap.get(harvestLog.uid.id),
                                ]
                            }
                        })
                        return rows
                    },
                    tableInputTypes(){
                        let userNameArray = []

                        const userKeyIterator = this.userToIDMap.keys()

                        for(i = 0; i < this.userToIDMap.size; i++){
                            userNameArray.push(userKeyIterator.next().value)
                        }

                        let cropNameArray = []

                        for(let [key, info] of this.cropToIDMap){
                            cropNameArray.push(key)
                        }
                        let fieldNameArray = []

                        const fieldKeyIterator = this.areaToIDMap.keys()

                        for(i = 0; i < this.areaToIDMap.size; i++){
                            fieldNameArray.push(fieldKeyIterator.next().value)
                        }
                        let unitNameArray = []
                        
                        const unitKeyIterator = this.unitToIDMap.keys()
                        
                        for(i = 0; i < this.unitToIDMap.size;i++){
                            unitNameArray.push(unitKeyIterator.next().value)
                        }
                        return [{type:'date'}, {type:'dropdown', value: cropNameArray}, {type:'dropdown', value: fieldNameArray}, {type:'number'}, {type:'dropdown', value: unitNameArray}, {type:'number'}, {type:'text'}, {type:'dropdown', value: userNameArray}]
                    },
                },
                created() {
                    getSessionToken().then((response) => {
                        this.sessionToken = response
                    })
                    getIDToCropMap().then((response) => {
                        this.idToCropMap = new Map(response)
                    })
                    getCropToIDMap().then((response) => {
                        this.cropToIDMap = new Map(response)
                    })
                    getIDToUserMap().then((response) => {
                        this.idToUserMap = new Map (response)
                    })
                    getUserToIDMap().then((response) => {
                        this.userToIDMap = new Map (response)
                    })
                    getAreaToIDMap().then((response) => {
                        this.areaToIDMap = new Map(response)
                    })
                    getUnitToIDMap().then((response) => {
                        this.unitToIDMap = new Map(response)
                    })
                }
           });
           Vue.config.devtools = true;
       </script>
    </body>
</html>