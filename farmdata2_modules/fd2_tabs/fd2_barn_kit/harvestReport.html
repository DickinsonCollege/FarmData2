<!DOCTYPE html>
<html lang="en">
    <head>   
    </head>

    <body>

        <h1>
           
            <center>Harvest Report</center>
        </h1>
        <p>
            <center>This is a tab to retrieve harvest reports.</center>
        </p>
        <p>
            <div id="rpt" class = "v-cloak">
                <br/>
                <UL>
                <!-- A fieldset groups a collection of input elements to create a form -->
                    <fieldset class="panel panel-default">
                        <!--Legend is used to create a header in the fieldset-->
                        <legend class="panel-heading fd2-legend">
                             <center>Harvest Report</center>
                        </legend>

                        <center>
                            <p>Layout content for the panel here.</p>

                            <div class="center-block">
                                <div class = "add-item">
                       <date-range-selection 
                            default-start-date="2021-01-15" 
                            :default-end-date=dateRangeMaxDate
                            @start-date-changed='startDateChange' 
                            @end-date-changed='endDateChange' 
                        >
                        </date-range-selection> 
                        <!-- Create drop down list for month-day-year to make it more accessible for mobile usage -->
                    <br/>
                        <dropdown-with-all 
                            includes-all 
                            :default-input=pickedCrop
                            :dropdown-list=mapToCropArray
                            @selection-changed="cropChange">
                            Crop:
                        </dropdown-with-all>
                        <dropdown-with-all 
                            includes-all 
                            :default-input=chosenField
                            :dropdown-list=mapToFieldArray
                            @selection-changed="FieldChange">
                            Field:
                        </dropdown-with-all>
                    <br/>
                    <br/>
                    <button class="btn fd2-red-button" @click="runFilter">Run Filter</button>

                    </div>
                            </div>
                        </center>
                    </fieldset>
                </UL>
                
                    <hr/> 
                        
                    <p>
                        Create UI suitable Reports Results
                    </p>
                        <!-- <custom-table 
                            can-delete 
                            can-edit
                            :headers="tableHeaders" 
                            :input-options="tableinputTypes"
                            :rows="tableData"
                            :visible-columns="tableVisibleColumns"  
                            @row-deleted="deleteTableRow"
                            @row-edited="updateTableRow">
                        </custom-table> -->
                        
                        
                        
        </p>
       <script>
           var ReportVue= new Vue({
                el:"#rpt",
                components: {
                    // Register the components used and define the tag name to be used.
                    'dropdown-with-all': DropdownWithAllComponent,
                    'date-range-selection': DateRangeSelectionComponent,
                    'custom-table': CustomTableComponent,
                },
                data:{
                    userID: fd2UserID,
                    userName: fd2UserName,
                    
                    startDate: null,
                    endDate: null,
                    dateRangeClicks: 0,
                    dateRangeMaxDate: dayjs().format("YYYY-MM-DD"),
                
                    pickedCrop:"All",
                    chosenField:"All",

                    sampleLog:[
                    ],

                    Farm:"",
                    User:"",
                    Language:"",

                    idToCropMap: [],
                    idToFieldMap: [],

                    LogListRetrieved:[],
                    LogList:[],

                    tableData: [],

                    // tableHeaders: ['Row', 'Date', 'Area', 'Crop', 'Yield', 'Units', 'Edit', 'Delete'],
                    // // Trouble with creating the table here <Try looking into How Vue cycle>
                    // tableinputTypes: [
                    //     {'type': 'number', 'value': this.tableData.map(index, log => index)},
                    //     {'type': 'text', 'value': this.tableData.map(index, log => log.data[0])},
                    //     {'type': 'dropdown', 'value': this.idToFieldMap},
                    //     {'type': 'dropdown', 'value': this.idToCropMap},
                    //     {'type': 'number'},
                    //     {'type': 'text'},
                    // ],

                },
                computed:{
                    mapToCropArray(){
                        return Array.from(this.idToCropMap.values())
                    },

                    mapToFieldArray(){
                        return Array.from(this.idToFieldMap.values())
                    },
                },
                created() {
                        getIDToCropMap()
                            .then((theMap1) => {
                                    this.idToCropMap= theMap1
                            })
                            .catch((err) => {

                            }),
                        getIDToAreaMap()
                            .then((theMap2) => {
                                    this.idToFieldMap = theMap2
                            })
                            .catch((err) => {
                                // An error occured during the request, process it here.
                            })
                    },
                

                methods: {
                    runFilter: function () {//This is pointless make this into retrieving the API and implement the filters to return the items depending the actually results
                        axios
                            .get('http://localhost/farm.json')
                            .then(response => {
                                    console.log("Got Response")
                                    this.Farm = response.data.name
                                    this.User = response.data.user.name
                                    this.Language = response.data.languages.en.name
                                })
                            .catch(error => {
                                	console.log("Error Occurred")
                                })
                                
                        let timestampStart = dayjs(this.startDay).unix();
                        let timestampEnd = dayjs(this.endDay).unix();

                        
                        
                        getAllPages("/log.json?type=farm_harvest&timestamp[ge]=" +timestampStart +"&timestamp[le]=" + timestampEnd, this.LogList)
                        .then(() => {
                            let tableRows = [];
                            for(let log of this.LogList) {
                                let tableRow = {
                                    id: this.LogList.indexOf(log),
                                    data: [
                                    log.timestamp,
                                    log.area[0].name,
                                    this.idToCropMap.get(log.data.crop_tid),
                                    log.quantity[0].value,
                                    log.quantity[0].unit.name,
                                    ]
                                }
                                tableRows.push(tableRow);
                            }
                            this.LogListRetrieved = tableRows;
                            this.tableData = this.LogListRetrieved;
                        })
                        // Retrieve data from the API through a certain filter
                        // Test this with a span of date, a certain crop or field
                    },
                    startDateChange(newDate) {
                            this.startDate = newDate
                        },
                    cropChange(newCrop) {
                            this.pickedCrop = newCrop
                        },
                    FieldChange(newField) {
                            this.chosenField = newField
                        },
                    endDateChange(newDate) {
                            this.endDate = newDate
                        },
                    deleteTableRow: function(rowID) {//Make this also changes values in the API
                        for(var i=0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                this.tableData.splice(i, 1)
                            }
                        }
                    },
                    updateTableRow: function(edits, rowID) {//Make this also changes values in the API
                        for(var i=0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                for( const [key, value] of Object.entries(edits)) {
                                    this.tableData[key] = value
                                }
                            }
                        }
                
                    }
                }
           });
           Vue.config.devtools = true;
       </script>
    </body>
</html>
                    <!-- I know this is a lot left to do but I can do it!!! Fighting!!! -->