<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <label for="field">Field: </label>
        <select v-model="reportField">
            <option v-for="field in fields">{{field}}</option>
        </select>

        <div>
            <label for="start">Start:</label>
            <input type="date" id="start" :max="reportEndDate" v-model="reportStartDate" />

            <label for="end">End:</label>
            <input type="date" id="end" :min="reportStartDate" v-model="reportEndDate" />
        </div>

        <br /><br />
        <label for="”crop”">Crop:</label>
        <select id="crop" v-model="harvRptCrop">
            <option v-for="crop in harvCrops">{{ crop }}</option>
        </select>
        <br /><br />

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{' ' + reportStartDate}}</li>
                <li><strong>End:</strong> {{' ' + reportEndDate}}</li>
                <li><strong>Crop:</strong>{{' ' + titleCrop }}</li>
                <li><strong>Field: </strong>{{' ' + reportField}}</li>
            </ul>
            <br />
            <p v-if="harvTable.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvTable">
                    <td>{{ timestampToYMD(harvLog.date) }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ harvLog.crop }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>{{ harvLog.worker }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
            <p>Total Yield:</p>
            <table border="1">
                <tr v-for="cropYield in yieldTable">
                    <td>{{ cropYield[0] }}</td>
                    <td>{{ cropYield[1] }}</td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data() {
                return {
                    rptPath: this.getRequestURL,
                    harvRptTitle: 'My Harvest Report',
                    harvRptCrop: 'ALL',
                    titleCrop: 'ALL',
                    visible: false,
                    harvHeaders: [
                        'Date',
                        'Field',
                        'Crop',
                        'Yield',
                        'Worker',
                        'Delete',
                    ],
                    cropIdPairsFw: new Map(),
                    cropIdPairsBw: new Map(),
                    UserIdPairs: new Map(),
                    harvCrops: [],
                    harvTable: [],
                    yieldTable: [],
                    reportField: 'ALL',
                    fields: ['ALL'],
                    reportStartDate: this.firstDateOfYear(),
                    reportEndDate: this.currentDate(),
                };
            },
            methods: {
                genHarvRpt: function () {
                    this.visible = true;
                    this.makePath();
                    axios.get(this.rptPath).then((response) => {
                        this.harvTable = response.data.list.map((entry) => {
                            return {
                                date: entry.timestamp, //make human readable
                                field: entry.area[0].name,
                                crop: this.cropIdPairsFw.get(entry.asset[0].id),
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                                worker: this.userIdPairs.get(entry.uid.id),
                            };
                        });
                        this.totalYield();
                        this.titleCrop = this.harvRptCrop;
                    });
                },

                deleteHarvLog: function (nameIndex) {
                    this.yieldTable = [];
                    this.harvTable.splice(nameIndex, 1);
                    this.totalYield();
                },
                totalYield: function () {
                    this.yieldTable = [];
                    yieldTypes = new Map();
                    for (log in this.harvTable) {
                        value = parseFloat(
                            this.harvTable[log].yield.split(' ')[0]
                        );
                        cropUnit =
                            this.harvTable[log].crop +
                            'SPLIT_HERE' +
                            this.harvTable[log].yield.split(' ')[1];

                        if (yieldTypes.has(cropUnit)) {
                            yieldTypes.set(
                                cropUnit,
                                yieldTypes.get(cropUnit) + value
                            );
                        } else {
                            yieldTypes.set(cropUnit, value);
                        }
                    }
                    entries = [...yieldTypes.entries()];
                    for (entry in entries) {
                        addition = [
                            entries[entry][0].split('SPLIT_HERE')[0],
                            entries[entry][1] +
                                ' ' +
                                entries[entry][0].split('SPLIT_HERE')[1],
                        ];
                        this.yieldTable.push(addition);
                    }
                    this.yieldTable.sort();
                },
                // makePath: function () {
                //     this.rptPath =
                //         '/log.json?type=farm_harvest' +
                //         (this.reportField !== 'All'
                //             ? '&area=' + this.reportField
                //             : '') +
                //         '&timestamp[ge]=' +
                //         this.YMDToTimestamp(this.reportStartDate) +
                //         '&timestamp[lt]=' +
                //         this.TimestampFollowingDay(this.reportEndDate);
                //     // +'&timestamp[ge]=' +
                //     // this.YMDToTimestamp(this.rptStart) + '&timestamp[le]=' +this.YMDToTimestamp(this.rptEnd);
                //     console.log(this.rptPath);
                // },
                makePath: function () {
                    this.rptPath = '/log.json?type=farm_harvest';

                    if (!(this.harvRptCrop == 'ALL')) {
                        this.rptPath +=
                            '&asset=' +
                            this.cropIdPairsBw.get(this.harvRptCrop);
                    }

                    if (!(this.reportField == 'ALL')) {
                            this.rptPath += '&area=' + this.reportField;
                        }
                    this.rptPath +=
                            '&timestamp[ge]=' +
                            this.YMDToTimestamp(this.reportStartDate) +
                            '&timestamp[lt]=' +
                            this.TimestampFollowingDay(this.reportEndDate);
                },
                YMDToTimestamp: function (ymd) {
                    let d = new Date(ymd);
                    return Math.round(
                        d.getTime() / 1000 + new Date().getTimezoneOffset() * 60
                    );
                },
                TimestampFollowingDay: function (ymd) {
                    return this.YMDToTimestamp(ymd) + 60 * 60 * 24;
                },
                timestampToDate: function (timestamp) {
                    return new Date(timestamp * 1000);
                },
                timestampToYMD: function (timestamp) {
                    let d = this.timestampToDate(timestamp);
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
                },
                firstDateOfYear: function () {
                    const date = new Date().getFullYear() + '-01-01';
                    return date;
                },
                currentDate: function () {
                    const d = new Date();
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
                },
            },

            created() {
                axios
                    .get('/taxonomy_term.json?area_type=field')
                    .then((response) => {
                        this.fields.push(
                            ...response.data.list.map((f) => f.name).sort()
                        );
                    })
                    .catch((error) => {
                        this.fields = ['Service Unavailable'];
                        console.log(error);
                    });
                axios
                    .get('/farm_asset.json?type=planting')
                    .then((response) => {
                        this.cropIdPairsFw = new Map(
                            response.data.list.map((f) => [f.id, f.name])
                        );
                        this.cropIdPairsBw = new Map(
                            response.data.list.map((f) => [f.name, f.id])
                        );
                        this.cropIdPairsFw.set('ALL', 'ALL');
                        this.cropIdPairsBw.set('ALL', 'ALL');
                        this.harvCrops = Array.from(
                        this.cropIdPairsFw.values()
                        ).sort();
                    })
                    .catch((error) => {
                        this.fields = ['Service Unavailable'];
                        console.log(error);
                    });
                axios
                    .get('/user')
                    .then((response) => {
                        this.userIdPairs = new Map(
                            response.data.list.map((f) => [f.uid, f.name])
                        );
                    })
                    .catch((error) => {
                        this.fields = ['Service Unavailable'];
                        console.log(error);
                    });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
