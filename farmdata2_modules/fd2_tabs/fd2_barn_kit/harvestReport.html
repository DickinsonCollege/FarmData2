<!DOCTYPE html>
<html lang="en">
    <head></head>
    <body>
        <h1 class="text-center">Harvest Report</h1>
            <div id="rpt" class = "v-cloak">
                    <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 50%;">
                        <legend class="panel-heading fd2-legend">
                             <center>Date Span</center>
                        </legend>
                        <div class="center-block">
                            <div style="display: flex;width: 100%; padding: 7px">
                                <date-range-selection 
                                    class="center-block"  
                                    :default-start-date=startDate :default-end-date=endDate
                                    @start-date-changed='startDateChange'
                                    @end-date-changed='endDateChange' 
                                    @click='hide'>
                                </date-range-selection>
                            <button class="btn center-block btn-primary" v-if='!reportVisible' @click='harvestLogRequestInDateSpan'>Run Date Filter</button>
                            </div>
                        </div>
                    </fieldset>

                <div v-if='reportVisible'>    
                    <div v-if="harvestLogs.length != 0">
                        <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 75%;">              
                            <legend class="panel-heading fd2-legend">
                                <center>Filters</center>
                            </legend>            
                            <div style="display: flex;width: 100%; padding: 7px">
                                <dropdown-with-all class="center-block" :dropdown-list=cropList includes-all default-input='All' @selection-changed='cropChange'>Crop:</dropdown-with-all>
                                <dropdown-with-all class="center-block" :dropdown-list=fieldList includes-all default-input='All' @selection-changed='fieldChange'>Field:</dropdown-with-all> 
                            </div>
                        </fieldset>
                    
                        <custom-table 
                            can-delete 
                            can-edit
                            :headers="tableHeaders" 
                            :input-options="tableInputTypes"
                            :rows="tableData"
                            :visible-columns="tableVisibleColumns"  
                            @row-deleted="deleteTableRow"
                            @row-edited="updateTableRow"
                            @edit-clicked='disableFilters' 
                            @row-canceled='enableFilters'>
                        </custom-table>
                    </div>
                    <div class="loader center-block" v-if="stillLoading"></div>
                    <div v-if="!stillLoading && harvestLogs.length == 0">
                        <div class="box" data-cy="no-logs-message" style="  
                            border: 5px solid #d62a17;
                            background-color: white;
                            padding: 20px;
                            margin: auto;
                            width: 50%;
                            text-align: center;
                            font-size: large;">
                            No Logs Found in These Dates 
                        </div> 
                    </div>
                </div>
            </div>    
                        
                        
       
       <script>
           var ReportVue= new Vue({
                el:"#rpt",
                components: {
                    'dropdown-with-all': DropdownWithAllComponent,
                    'date-range-selection': DateRangeSelectionComponent,
                    'custom-table': CustomTableComponent,
                },
                data:{
                    //Data upon initialization
                    sessionToken: null,
                    
                    startDate: dayjs().format('YYYY-MM-DD').toString(),
                    endDate: dayjs().format('YYYY-MM-DD').toString(),  
                
                    chosenCrop:"All",
                    chosenField:"All",
                    
                    
                    rowBeingEdited : false,
                    reportVisible: false,
                    
                    //Processing data segment
                    stillLoading: true,
                    harvestLogs:[],
                    updateLog:[],
                    Farm:"",
                    User:"",
                    Language:"",

                    idToCropMap: new Map(),
                    cropToIDMap: new Map(),
                    idToUserMap: new Map(),
                    userToIDMap: new Map(),
                    areaToIDMap: new Map(),
                    unitToIDMap: new Map(),

                    tableHeaders: [ 'Date', 'Crop', 'Field', 'Yield', 'Unit', 'Hours', 'Comments', 'Users', 'Edit', 'Delete'],
                    tableVisibleColumns:[true, true, true, true, true, true, true, true],

                },
                methods: {
                    hide(){
                        this.reportVisible = false
                        this.harvestLogs = []
                    },
                    startDateChange(newDate) {
                            this.startDate = newDate
                        },
                    endDateChange(newDate) {
                            this.endDate = newDate
                        },    
                    cropChange(selectedCrop) {
                            this.chosenCrop = selectedCrop
                        },
                    fieldChange(selectedField) {
                            this.chosenField = selectedField
                        },
                    harvestLogRequestInDateSpan(){
                            this.reportVisible = true
                            let link = '/log.json?type=farm_harvest&timestamp[ge]=' + dayjs(this.startDate).unix() + '&timestamp[le]=' + dayjs(this.endDate).unix()
                            getAllPages(link,this.harvestLogs).then(()=>{
                                this.stillLoading = false
                            })
                            this.stillLoading = true
                    },    
                    
                    deleteTableRow(logID) {
                        let url = '/log/' + logID
                        deleteRecord(url, this.sessionToken)
                        for(var i = 0; i < this.harvestLogs.length; i++){
                            if(this.harvestLogs[i].id === logID){
                                this.harvestLogs.splice(i, 1)
                            }
                        }
                    },

                    // updateTableRow(edits, rowID) {
                    //     let url = '/log/' + logID
                    //     for(var i = 0; i < this.tableData.length; i++){
                    //         if(this.tableData[i].id == rowID){
                    //             for( const [key, value] of Object.entries(edits)) {
                    //                 this.tableData[key] = value
                    //             }
                    //         }
                    //     }
                        
                    //     if(!(Object.entries(edits).length === 0)){
                    //     updateRecord(url, edits, this.sessionToken)
                    // }

                    //     // Would also need to update data in the db via API here.
                    // },
                    
                    updateTableRow(updateObject, id){
                        this.updateLog = this.harvestLogs.filter((x) => x.id === id)
                        let updateHarvestObject = {}
                
                        /**
                         * The Table component returns an object with the cells that were updated. We don't know how many or which ones where updated, so we check for all possible cells that could have been updated.
                         */
                        let keys = Object.keys(updateObject)
                        if(keys.includes('Yield') || keys.includes('Unit') || keys.includes('Hours')){
                            updateHarvestObject['quantity'] = this.quantityFarmHarvest
                        }
                        
                        for(i=0; i < keys.length; i++){
                            if(keys[i] == 'Date'){ //works
                                updateHarvestObject['timestamp'] = dayjs(updateObject['Date'], 'YYYY-MM-DD').unix()
                            }
                            else if(keys[i] == 'Crop'){ //works
                                updateHarvestObject['data'] = {"crop_tid": this.cropToIDMap.get(updateObject['Crop'])}
                            }
                            else if (keys[i] == 'Field'){ //works
                                updateHarvestObject['area'] = [{ 'id': this.areaToIDMap.get(updateObject['Field']),
                                    "resource": "taxonomy_term",}]
                            }
                            else if (keys[i] == 'Yield'){ //not yet
                               updateHarvestObject.quantity[quantityLocation(updateHarvestObject.quantity, 'Harvest')].value = updateObject['Units']
                               this.updateLog[0].quantity[quantityLocation(this.updateLog[0].quantity, 'Harvest')].value = updateObject['Units']
                            }
                            else if (keys[i] == 'Unit'){ //not yet
                                updateHarvestObject.quantity[quantityLocation(updateHarvestObject.quantity, 'Harvest')].unit.name.value = updateObject['Units']
                                this.updateLog[0].quantity[quantityLocation(this.updateLog[0].quantity, 'Harvest')].unit.name.value = updateObject['Units']
                            }
                            else if (keys[i] == 'Hours'){ //works
                                updateHarvestObject.quantity[quantityLocation(updateHarvestObject.quantity, 'Labor')].value = updateObject['Hours']

                                this.updateLog[0].quantity[quantityLocation(this.updateLog[0].quantity, 'Labor')].value = updateObject['Hours']
                            }
                            else if(keys[i] == 'Comments'){ //works
                                updateHarvestObject['notes'] = {'value': updateObject['Comments'],
                                    'format': 'farm_format'}
                            }
                            else if(keys[i] == 'Users'){ //works
                                updateHarvestObject['uid'] = {
                                    'id': this.userToIDMap.get(updateObject['Users']),
                                    'resource': 'user'
                                }
                            }
                        }
                        
                        if(keys.includes('Yield') || keys.includes('Unit') || 
                            keys.includes('Hours')){
                            for(var i=0; i < this.harvestLogs.length; i++){
                                if(this.harvestLogs[i].id === id){
                                    this.harvestLogs.splice(i, this.updateLog)
                                }
                            }
                        }

                        let harvestUrl = '/log/' + id
                        //call updateRecord function to update harvest log
                        if(!(Object.entries(updateHarvestObject).length === 0)){
                            updateRecord(harvestUrl, updateHarvestObject,this.sessionToken)
                        }
                        this.rowBeingEdited = false
                },

                    disableFilters() {
                        this.rowBeingEdited = true
                    },
                    enableFilters(){
                        this.rowBeingEdited = false
                    },
                },
                computed:{
                    cropList(){
                        let harvestFilter = this.harvestLogs.filter((log) => log)
                        let cropArray = []
                        if(this.chosenField != 'All') {
                            let fieldFilter = harvestFilter.filter((log) => log.area[0].name === this.chosenField)
                            cropArray = fieldFilter.map(log => 
                                this.idToCropMap.get(log.data.crop_tid)
                            )
                        }
                        else {
                            cropArray = harvestFilter.map((log) => this.idToCropMap.get(log.data.crop_tid))
                        }

                        let crops = new Set(cropArray)
                        let newCropArray = Array.from(crops)
                        return newCropArray.sort()
                    },
                    fieldList(){
                        let harvestFilter = this.harvestLogs.filter((log) => log)
                        let fieldArray = []
                        if(this.chosenCrop != 'All'){
                            let cropFilter = harvestFilter.filter((log) => this.idToCropMap.get(log.data.crop_tid) === this.chosenCrop)
                            fieldArray = cropFilter.map(log =>
                                log.area[0].name
                            )
                        }
                        else{
                            fieldArray = harvestFilter.map(log =>
                                log.area[0].name
                            )
                        }
                        let fields = new Set(fieldArray)
                        let newfieldArray = Array.from(fields)
                        return newfieldArray.sort()
                    },
                    tableData() {
                        let filterRows = this.harvestLogs.filter((log) => log)

                        if(this.chosenField != 'All'){
                            filterRows = filterRows.filter((log) => log.area[0].name === this.chosenField)
                        }
                        if(this.chosenCrop != 'All'){
                            filterRows = filterRows.filter((log) => this.idToCropMap.get(log.data.crop_tid) === this.chosenCrop)
                        }
                        let $vm = this
                        let rows = filterRows.map(function(harvestLog) {
                            return{
                                id: harvestLog.id,
                                data: [
                                    dayjs.unix(harvestLog.timestamp).format('YYYY-MM-DD'),
                                    $vm.idToCropMap.get(harvestLog.data.crop_tid),
                                    harvestLog.area[0].name, 
                                    harvestLog.quantity[0].value,
                                    harvestLog.quantity[0].unit.name,
                                    (Math.round(harvestLog.quantity[1].value*100))/100,
                                    harvestLog.notes.value,
                                    $vm.idToUserMap.get(harvestLog.uid.id),
                                ]
                            }
                        })
                        return rows
                    },
                    tableInputTypes(){
                        let userNameArray = []

                        const userKeyIterator = this.userToIDMap.keys()

                        for(i = 0; i < this.userToIDMap.size; i++){
                            userNameArray.push(userKeyIterator.next().value)
                        }

                        let cropNameArray = []

                        for(let [key, info] of this.cropToIDMap){
                            cropNameArray.push(key)
                        }
                        let fieldNameArray = []

                        const fieldKeyIterator = this.areaToIDMap.keys()

                        for(i = 0; i < this.areaToIDMap.size; i++){
                            fieldNameArray.push(fieldKeyIterator.next().value)
                        }
                        let unitNameArray = []
                        
                        const unitKeyIterator = this.unitToIDMap.keys()
                        
                        for(i = 0; i < this.unitToIDMap.size;i++){
                            unitNameArray.push(unitKeyIterator.next().value)
                        }
                        return [{type:'date'}, {type:'dropdown', value: cropNameArray}, {type:'dropdown', value: fieldNameArray}, {type:'number'}, {type:'dropdown', value: unitNameArray}, {type:'number'}, {type:'text'}, {type:'dropdown', value: userNameArray}]
                    },
                    /**
                     * returns the structure for updating the quantity section of the Harvest Report Logs. The values have not been updated yet.
                     */
                    quantityFarmHarvest(){
                        return [
                            {
                                "measure": "weight", 
                                "value": this.updateLog[0].quantity[0].value,
                                "unit": {
                                    "id": this.unitToIDMap.get('POUND'), 
                                    "resource": "taxonomy_term"
                                },
                                "label": "Harvest"
                            },
                            {
                                "measure": "time", 
                                "value": this.updateLog[0].quantity[1].value,
                                "unit": {
                                    "id": this.unitToIDMap.get('HOURS'),
                                    "resource": "taxonomy_term"
                                },
                                "label": "Labor"
                            },
                            {
                                "measure": "count", 
                                "value": this.updateLog[0].quantity[2].value,
                                "unit": {
                                    "id": this.unitToIDMap.get('PEOPLE'),
                                    "resource": "taxonomy_term"
                                },
                                "label": "Workers"
                            },
                        ]
                    },
                },
                created() {
                    getSessionToken().then((response) => {
                        this.sessionToken = response
                    })
                    getIDToCropMap().then((response) => {
                        this.idToCropMap = new Map(response)
                    })
                    getCropToIDMap().then((response) => {
                        this.cropToIDMap = new Map(response)
                    })
                    getIDToUserMap().then((response) => {
                        this.idToUserMap = new Map (response)
                    })
                    getUserToIDMap().then((response) => {
                        this.userToIDMap = new Map (response)
                    })
                    getAreaToIDMap().then((response) => {
                        this.areaToIDMap = new Map(response)
                    })
                    getUnitToIDMap().then((response) => {
                        this.unitToIDMap = new Map(response)
                    })
                }
           });
           Vue.config.devtools = true;
       </script>
    </body>
</html>