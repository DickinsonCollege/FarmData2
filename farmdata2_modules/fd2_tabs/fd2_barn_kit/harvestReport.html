<!DOCTYPE html>
<html lang="en">
    <head>   
    </head>

    <body>
        <!-- Center the work to the middle of the page -->
        <h1>
            <!-- Add extra formatting to highlight the title of the page -->
            <center>Harvest Report</center>
        </h1>
        <p>
            <center>This is a tab to retrieve harvest reports.</center>
        </p>
        <p>
            <div id="rpt" class = "v-cloak">
                <br/>
                <div class = "add-item">
                        <label for="StartDate">From:</label>
                        <input type="date" id="start" name="filter start limit day" v-model=startDay min="2014-01-01" :max="endDay">
                    <br/>    
                        <label for="EndDate">To:</label>
                        <input type="date" id="end" name="filter end limit day" v-model=endDay :min="startDay" max="2022-01-01" >
            <!-- Create drop down list for month-day-year to make it more accessible for mobile usage -->
                    <br/>
                        <label for="CropType">Crop:</label>
                            <select id="groups" name="Crop" v-model="chosenCrop">
                                <optgroup label="possible crops"> 
                                    <option v-for="item in mapToCropArray">{{item}}</option>
                                </optgroup> <br/>
                            </select>

                        <label for="FieldType">Field:</label>
                            <select id="groups" name="Field" v-model="chosenField">
                                <optgroup label="possible fields"> 
                                    <option v-for="item in mapToFieldArray">{{item}}</option>
                                </optgroup>
                        </select>
                    <br/>

                    <button type="btn btn-primary" @click="runFilter">Run Filter</button>

                    </div>
                    <hr/> 
                        <!--
                            Ask professor whether or not we need to look into cypress 
                            to imitate the style of the  
                        -->
                    <p>
                        Create UI suitable Reports Results
                    </p>
                        <custom-table data-cy="test-table"
                            can-delete 
                            can-edit
                            :headers="tableHeaders" 
                            :input-options="tableinputTypes"
                            :rows="tableData"
                            :visible-columns="tableVisibleColumns"  
                            @row-deleted="deleteTableRow"
                            @row-edited="updateTableRow">
                        </custom-table>
                        
                        
                        
        </p>
       <script>
           var ReportVue= new Vue({
                el:"#rpt",
                components: {
                    // Register the components used and define the tag name to be used.
                    
                    'custom-table': CustomTableComponent,
                },
                data:{
                    Response:null,
                    
                    startDay: "2020-05-01",
                    endDay: "2020-05-15",
                
                    chosenCrop:"Kale",
                    chosenField:"All",

                    sampleLog:[
                    ],

                    Farm:"",
                    User:"",
                    Language:"",

                    idToCropMap: [],
                    idToFieldMap: [],

                    LogListRetrieved:[],
                    LogList:[],


                    tableHeaders: ['Row', 'Date', 'Area', 'Crop', 'Yield', 'Units', 'Edit', 'Delete'],
                    tableinputTypes: [
                        {'type': 'number', 'value': this.tableData.map(index, log => index)},
                        {'type': 'text', 'value': this.tableData.map(index, log => log.data[0])},
                        {'type': 'dropdown', 'value': this.idToFieldMap},
                        {'type': 'dropdown', 'value': this.idToCropMap},
                        {'type': 'number'},
                        {'type': 'text'},
                    ],
                    tableData: [],
                    tableVisibleColumns: [true, true, false, true, true, true],

                },
                computed:{
                    mapToCropArray(){
                        return Array.from(this.idToCropMap.values())
                    },

                    mapToFieldArray(){
                        return Array.from(this.idToFieldMap.values())
                    },
                    
                },
                created() {
                        getIDToCropMap()
                            .then((theMap1) => {
                                    this.idToCropMap= theMap1
                            })
                            .catch((err) => {

                            }),
                        getIDToAreaMap()
                            .then((theMap2) => {
                                    this.idToFieldMap = theMap2
                            })
                            .catch((err) => {
                                // An error occured during the request, process it here.
                            })
                    },
                

                methods: {
                    runFilter: function () {
                        axios
                            .get('http://localhost/farm.json')
                            .then(response => {
                                    console.log("Got Response")
                                    this.Farm = response.data.name
                                    this.User = response.data.user.name
                                    this.Language = response.data.languages.en.name
                                })
                            .catch(error => {
                                	console.log("Error Occurred")
                                })
                                
                        let timestampStart = dayjs(this.startDay).unix();
                        let timestampEnd = dayjs(this.endDay).unix();

                        let logString = "";

                        if(this.ANewLog !== {}){
                            this.sampleLog.push(this.ANewLog);
                        } 
                        
                        getAllPages("/log.json?type=farm_harvest&timestamp[ge]=" +timestampStart +"&timestamp[le]=" + timestampEnd, this.LogList)
                        .then(() => {
                            let tableRows = [];
                            for(let log of this.LogList) {
                                let tableRow = {
                                    id: this.LogList.indexOf(log),
                                    data: [
                                    log.timestamp,
                                    log.area[0].name,
                                    this.idToCropMap.get(log.data.crop_tid),
                                    log.quantity[0].value,
                                    log.quantity[0].unit.name,
                                    ]
                                }
                                tableRows.push(tableRow);
                            }
                            this.LogListRetrieved = tableRows;
                            this.tableData = this.LogListRetrieved;
                            
                        // Retrieve data from the API through a certain filter
                        // Test this with a span of date, a certain crop or field
                    },
                    
                    deleteTableRow: function(rowID) {
                        for(var i=0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                this.tableData.splice(i, 1)
                            }
                        }
                    },
                    updateTableRow: function(edits, rowID) {
                        for(var i=0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                for( const [key, value] of Object.entries(edits)) {
                                    this.tableData[key] = value
                                }
                            }
                        }
                
                    }
                }
           });
           Vue.config.devtools = true;
       </script>
    </body>
</html>
                    <!-- I know this is a lot left to do but we can do it!!! Fighting!!! -->