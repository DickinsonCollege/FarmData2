<!DOCTYPE html>
<html lang="en">
    <head></head>
    <body>
        <h1 class="text-center">Harvest Report</h1>
            <div id="rpt" class = "v-cloak">
                    <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 50%;">
                        <legend class="panel-heading fd2-legend">
                             <center>Date Span</center>
                        </legend>
                        <div class="center-block">
                            <div style="display: flex;width: 100%; padding: 7px">
                                <date-range-selection 
                                    class="center-block"  
                                    :default-start-date=startDate :default-end-date=endDate
                                    @start-date-changed='startDateChange'
                                    @end-date-changed='endDateChange' 
                                    @click='hide'>
                                </date-range-selection>
                            <button class="btn center-block btn-primary" v-if='!reportVisible' @click='HarvestLogRequestInDateSpan'>Run Date Filter</button>
                            </div>
                        </div>
                    </fieldset>

                <div v-if='reportVisible'>    
                    <div v-if="HRLog.length != 0">
                        <fieldset :disabled="rowBeingEdited" class="panel panel-default center-block" style="width: 75%;">              
                            <legend class="panel-heading fd2-legend">
                                <center>Filters</center>
                            </legend>            
                            <div style="display: flex;width: 100%; padding: 7px">
                                <dropdown-with-all class="center-block" :dropdown-list=cropList includes-all default-input='All' @selection-changed='CropChange'>Crop:</dropdown-with-all>
                                <dropdown-with-all class="center-block" :dropdown-list=fieldList includes-all default-input='All' @selection-changed='FieldChange'>Field:</dropdown-with-all> 
                            </div>
                        </fieldset>
                    
                        <custom-table 
                            can-delete 
                            can-edit
                            :headers="tableHeaders" 
                            :input-options="tableInputTypes"
                            :rows="tableData"
                            :visible-columns="tableVisibleColumns"  
                            @row-deleted="deleteTableRow"
                            @row-edited="updateTableRow"
                            @edit-clicked='disableFilters' 
                            @row-canceled='enableFilters'>
                        </custom-table>
                    </div>
                    <div class="loader center-block" v-if="stillLoading"></div>
                    <div v-if="!stillLoading && HRLog.length == 0">
                        <div class="box" data-cy="no-logs-message" style="  
                            border: 5px solid #d62a17;
                            background-color: white;
                            padding: 20px;
                            margin: auto;
                            width: 50%;
                            text-align: center;
                            font-size: large;">
                            No Logs Found in These Dates 
                        </div> 
                    </div>
                </div>
            </div>    
                        
                        
       
       <script>
           var ReportVue= new Vue({
                el:"#rpt",
                components: {
                    'dropdown-with-all': DropdownWithAllComponent,
                    'date-range-selection': DateRangeSelectionComponent,
                    'custom-table': CustomTableComponent,
                },
                data:{
                    //Data upon initialization
                    sessionToken: null,
                    
                    startDate: dayjs().format('YYYY-MM-DD').toString(),
                    endDate: dayjs().format('YYYY-MM-DD').toString(),  
                
                    chosenCrop:"All",
                    chosenField:"All",
                    
                    
                    rowBeingEdited : false,
                    reportVisible: false,
                    
                    //Processing data segment
                    stillLoading: true,
                    HRLog:[],
                    updateLog:[],
                    Farm:"",
                    User:"",
                    Language:"",

                    idToCropMap: new Map(),
                    cropToIDMap: new Map(),
                    idToUserMap: new Map(),
                    userToIDMap: new Map(),
                    areaToIDMap: new Map(),
                    unitToIDMap: new Map(),

                    tableHeaders: [ 'Date', 'Crop', 'Field', 'Yield', 'Unit', 'Hours','Comments', 'Users', 'Edit', 'Delete'],
                    tableVisibleColumns:[true, true, true, true, true, true, true, true],

                },
                methods: {
                    hide(){
                        this.reportVisible = false
                        this.HRLog = []
                    },
                    startDateChange(newDate) {
                            this.startDate = newDate
                        },
                    endDateChange(newDate) {
                            this.endDate = newDate
                        },    
                    CropChange(selectedCrop) {
                            this.chosenCrop = selectedCrop
                        },
                    FieldChange(selectedField) {
                            this.chosenField = selectedField
                        },
                    HarvestLogRequestInDateSpan(){
                            this.reportVisible = true
                            let link = '/log.json?type=farm_harvest&timestamp[ge]=' + dayjs(this.startDate).unix() + '&timestamp[le]=' + dayjs(this.endDate).unix()
                            getAllPages(link,this.HRLog).then(()=>{
                                this.stillLoading = false
                            })
                            this.stillLoading = true
                    },    
                    
                    deleteTableRow(logID) {
                        let url = '/log/' + logID
                        deleteRecord(url, this.sessionToken)
                        for(var i=0; i < this.HRLog.length; i++){
                            if(this.HRLog[i].id === logID){
                                this.HRLog.splice(i, 1)
                            }
                        }
                    },
                     updateTableRow(edits, rowID) {
                        for(var i=0; i < this.tableData.length; i++){
                            if(this.tableData[i].id == rowID){
                                for( const [key, value] of Object.entries(edits)) {
                                    this.tableData[key] = value
                                }
                            }
                        }

                        // Would also need to update data in the db via API here.
                    },
                //     updateTableRow(Object, id){
                //     this.updateLog = this.HRLog.filter((x) => x.id === id)
                //     let updateHarvestObject = {}
                //     let updatePlantObject = {}
                    
                //     let keys = Object.keys(updateObject)
                //     for(i=0; i < keys.length; i++){
                //         if(keys[i] == 'Date'){
                //             updateHarvestObject['timestamp'] = dayjs(updateObject['date'], 'YYYY-MM-DD').unix()
                //         }
                //         else if(keys[i] == 'Crop'){
                //             updateHarvestObject['data'] = {"crop_tid": this.cropToIDMap.get(updateObject['crop'])}
                //             updatePlantObject['crop'] = [{
                //                 "id": this.cropToIDMap.get(updateObject['crop']),
                //                 "resource": "taxonomy_term"
                //             }]
                //         }
                //         else if (keys[i] == 'Field'){
                //             updateHarvestObject['movement'] = { 'area': [{
                //                 "id": this.areaToIDMap.get(updateObject['area']),
                //                 "resource": "taxonomy_term",}]
                //             }
                //         }
                //         else if(keys[i] == 'Hours'){
                //             updateHarvestObject.quantity[quantityLocation(updateHarvestObject.quantity, 'Labor')].value = updateObject['Hours']

                //             this.updateLog[0].quantity[quantityLocation(this.updateLog[0].quantity, 'Labor')].value = updateObject['Hours']
                //         }
                //         else if(keys[i] == 'Num Workers'){
                //             updateHarvestObject.quantity[quantityLocation(updateHarvestObject.quantity, 'Workers')].value = updateObject['Num Workers']

                //             this.updateLog[0].quantity[quantityLocation(this.updateLog[0].quantity, 'Workers')].value = updateObject['Num Workers']
                //         }
                //         else if(keys[i] == 'Comments'){
                //             updateHarvestObject['notes'] = {'value': updateObject['Comments'],
                //                 'format': 'farm_format'}
                //         }
                //         else if(keys[i] == 'User'){
                //             updateHarvestObject['uid'] = {
                //                 'id': this.userToIDMap.get(updateObject['User']),
                //                 'resource': 'user'
                //             }
                //             updatePlantObject['uid'] = {
                //                 'id': this.userToIDMap.get(updateObject['User']),
                //                 'resource': 'user'
                //             }
                //         }  
                //     }
                
                    
                //     let HarvestURL = '/log/' + id
                //     let plantingUrl = '/farm_asset/' + this.updateLog[0].asset[0].id
                //     //call updateRecord function to update planting log
                //     if(!(Object.entries(updatePlantObject).length === 0)){
                //         updateRecord(plantingUrl, updatePlantObject, this.sessionToken)
                //     }
                //     //call updateRecord function to update seeding log
                //     if(!(Object.entries(updateHarvestObject).length === 0)){
                //         updateRecord(HarvestURL, updateHarvestObject,this.sessionToken)
                //     }
                //     this.rowBeingEdited = false
                // },
                    disableFilters() {
                        this.rowBeingEdited = true
                    },
                    enableFilters(){
                        this.rowBeingEdited = false
                    },
                },
                computed:{
                    cropList(){
                    let harvestFilter = this.HRLog.filter((x) => x)
                    let cropArray = []
                    if(this.chosenField != 'All'){
                        let fieldFilter = harvestFilter.filter((x) => x.area[0].name === this.chosenField)
                        cropArray = fieldFilter.map(h => 
                            this.idToCropMap.get(h.data.crop_tid)
                        )
                    }
                    else{
                        cropArray = harvestFilter.map(h=> 
                            this.idToCropMap.get(h.data.crop_tid)
                        )
                    }

                    let crops = new Set(cropArray)
                    let newCropArray = Array.from(crops)
                    return newCropArray.sort()
                },
                    fieldList(){
                        let harvestFilter = this.HRLog.filter((x) => x)
                        let fieldArray = []
                        if(this.chosenCrop != 'All'){
                            let cropFilter = harvestFilter.filter((x) => this.idToCropMap.get(x.data.crop_tid) === this.chosenCrop)
                            fieldArray = cropFilter.map(h =>
                                h.area[0].name
                            )
                        }
                        else{
                            fieldArray = harvestFilter.map(h =>
                                h.area[0].name
                            )
                        }
                        let fields = new Set(fieldArray)
                        let newfieldArray = Array.from(fields)
                        return newfieldArray.sort()
                    },
                    tableData() {
                        let filterRows = this.HRLog.filter((x) => x)

                        if(this.chosenField != 'All'){
                            filterRows = filterRows.filter((x) => x.area[0].name === this.chosenField)
                        }
                        if(this.chosenCrop != 'All'){
                            filterRows = filterRows.filter((x) => this.idToCropMap.get(x.data.crop_tid) === this.chosenCrop)
                        }
                        // let rows = filterRows.map(function(h) {
                        // for(let log of this.HRLog){
                        //     let row = {
                        //         id: this.HRLog.indexOf(log),
                        //         data:[
                        //             dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                        //             this.idToCropMap.get(log.data.crop_tid),
                        //             log.area[0].name, 
                        //             log.quantity[0].value,
                        //             log.quantity[0].unit.name,
                        //             (Math.round(log.quantity[1].value*100))/100,
                        //             log.notes.value,
                        //             this.idToUserMap.get(log.uid.id),
                        //         ]
                        //         }
                        //     rows.push(row)
                        // }
                        // return rows
                        let $vm = this
                        let rows = filterRows.map(function(h) {
                            return{
                                id: h.id,
                                data: [
                                    dayjs.unix(h.timestamp).format('YYYY-MM-DD'),
                                    $vm.idToCropMap.get(h.data.crop_tid),
                                    h.area[0].name, 
                                    h.quantity[0].value,
                                    h.quantity[0].unit.name,
                                    (Math.round(h.quantity[1].value*100))/100,
                                    h.notes.value,
                                    $vm.idToUserMap.get(h.uid.id),
                                ]
                            }
                        })
                        return rows
                    },
                    tableInputTypes(){
                        let userNameArray = []
                        const userKeyIterator = this.userToIDMap.keys()
                        for(i=0; i < this.userToIDMap.size; i++){
                            userNameArray.push(userKeyIterator.next().value)
                        }
                        let cropNameArray = []
                        for(let [key, info] of this.cropToIDMap){
                            cropNameArray.push(key)
                        }
                        let fieldNameArray = []
                        const fieldKeyIterator = this.areaToIDMap.keys()
                        for(i=0; i < this.areaToIDMap.size; i++){
                            fieldNameArray.push(fieldKeyIterator.next().value)
                        }
                        let unitNameArray = []
                        const unitKeyIterator = this.unitToIDMap.keys()
                        for(i = 0; i < this.unitToIDMap.size;i++){
                            unitNameArray.push(unitKeyIterator.next().value)
                        }
                        return [{type:'date'}, {type:'dropdown', value: cropNameArray}, {type:'dropdown', value: fieldNameArray}, {type:'number'}, {type:'dropdown', value: unitNameArray}, {type:'number'}, {type:'text'}, {type:'dropdown', value: userNameArray}]
                    },
                },
                created() {
                    getSessionToken().then((response) => {
                        this.sessionToken = response
                    })
                    getIDToCropMap().then((response) => {
                        this.idToCropMap = new Map(response)
                    })
                    getCropToIDMap().then((response) => {
                        this.cropToIDMap = new Map(response)
                    })
                    getIDToUserMap().then((response) => {
                        this.idToUserMap = new Map (response)
                    })
                    getUserToIDMap().then((response) => {
                        this.userToIDMap = new Map (response)
                    })
                    getAreaToIDMap().then((response) => {
                        this.areaToIDMap = new Map(response)
                    })
                    getUnitToIDMap().then((response) => {
                        this.unitToIDMap = new Map(response)
                    })
                }
           });
           Vue.config.devtools = true;
       </script>
    </body>
</html>
                    <!-- I know this is a lot left to do but I can do it!!! Fighting!!! -->