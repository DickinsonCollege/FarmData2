<head>
    <h1>Tray Seeding Report</h1>
</head> 
<body>
    <div id= "tray-seeding-report" v-cloak>
        <label for = "cropList">Crop:</label>
        <select id= "cropList" name = "simple" v-model="rptCrop">
            <ul>
                <option v-for="crop in crops">{{ crop }}</option>
            </ul>
        </select>

        <br>

        <label for="start">Start Date:</label>
        <input type="date" id="start" name="start" v-model="reportStart" min="2014-01-01" :max="reportEnd">

        <label for="end">End Date:</label>
        <input type="date" id="end" name="end" v-model="reportEnd" :min="reportStart" max="2022-01-01">
    <br>
        <button class="btn btn-primary" @click="traySeedingLogRequest">Generate Report</button>


    <div v-if="state === 'edit'">
        <hr />
        <h2>Mock Report</h2>
        <br>
        <ul>
            <li><strong>Start:</strong>{{reportStart}}</li>
            <li><strong>End:</strong>{{reportEnd}}</li>
            <li><strong>Crop:</strong>{{rptCrop}}</li>
        </ul>

            <br>
            <table border=1>
            <tr>
                <th>  Date of Seeding  </th>
                <th>  Crop  </th>
                <th>  Number of Seeds  </th>
                <th>  Number of Trays  </th>
                <th>  Cells per Tray  </th>
                <th>  Variety  </th>
                <th>  User  </th>
                <th>  Comments  </th>
                <th>  Delete  </th>
            </tr>


            <tr v-for="(log, index) in traySeedingLogs">
                <td>{{ timestampToYMD(log.date) }}</td>
                <td>{{ log.crop }}</td>
                <td>{{ log.numSeeds }}</td>
                <td>{{ log.numTrays }}   </td>
                <td>{{ log.cellsPerTray }}   </td>
                <td>{{ log.variety }}    </td>
                <td>{{ log.user }}     </td>
                <td>     </td>
                <td><button type="button" @click="popup(index);">Delete</button></td>
            </tr>
            </table>
        </div>
    </div>

    <p id="test"></p>

    <script>
        var databinding = new Vue({
            el: '#tray-seeding-report',
            data: {
                state: "default",
                crops: [],
                rptCrop: "Kale",
                reportStart: '2018-05-01',
                reportEnd: '2018-07-31',
                traySeedingLogs: [
                    {date: '05/02/2018', crop: 'Kale', numSeeds: '100'},
                    {date: '05/05/2018', crop: 'Kale', numSeeds: '200'}
                
                ],
            },
            methods: { 
                timestampToYMD: function(timestamp) {
                    let d = this.timestampToDate(timestamp);
                    const month = d.getMonth() < 9 ?
                                     '0' + (d.getMonth() + 1) :
                                    d.getMonth() + 1;
                    const day = d.getDate() < 10 ?
                                '0' + d.getDate() :
                                d.getDate();
                    return d.getFullYear() + "-" + month + "-" + day;
                },
                YMDToTimestamp: function(ymd) {
                        let d = new Date(ymd);
                        return Math.round(d.getTime()/1000 +
                                new Date().getTimezoneOffset()*60);
                },
                timestampToDate: function(timestamp) {
                        return new Date(timestamp * 1000);
                    },
                deleteReport: function(index) {
                    this.traySeedingLogs.splice(index, 1);
                },
                popup: function() {
                    var txt;
                    if (confirm("Deleting this record will NOT adjust the inventory of corresponding seed codes.")) {
                        deleteReport(index);
                    } else {
                        txt = "You pressed Cancel!";
                    }
                },
                    //document.getElementById("test").innerHTML = txt;
                traySeedingLogRequest: function() {
                    let s = this.YMDToTimestamp(this.reportStart);
                    let e = this.YMDToTimestamp(this.reportEnd);
                    if(this.rptCrop == 'All'){
                        axios.get('/log.json?type=farm_seeding&timestamp[ge]=' + s + '&timestamp[le]=' + e )
                        .then(response => {
                            this.traySeedingLogs = response.data.list.map(t => {
                                return {
                                    date:t.timestamp,
                                    crop:t.name,
                                    numSeeds: t.quantity[0]["measure"],
                                    numTrays: t.quantity[0]["value"],
                                    cellsPerTray: t.quantity[0]["label"].substring(0, t.quantity[0]["label"].length - 5),
                                    variety: t.notes.value.substring(3, t.notes.value.length - 5),
                                    user: t.log_owner[0]["resource"],
                                };
                            });
                        })
                    } else {
                        axios.get('/log.json?type=farm_seeding&timestamp[ge]=' + s + '&timestamp[le]=' + e + '&name=Seed%20' + this.rptCrop)
                        .then(response => {
                            this.traySeedingLogs = response.data.list.map(t => {
                                return {
                                    date:t.timestamp,
                                    crop:t.name,
                                    numSeeds: t.quantity[0]["measure"],
                                    numTrays: t.quantity[0]["value"],
                                    cellsPerTray: t.quantity[0]["label"].substring(0, t.quantity[0]["label"].length - 5),
                                    variety: t.notes.value.substring(3, t.notes.value.length - 5),
                                    user: t.log_owner[0]["resource"],
                                };
                            });
                        })
                    }
                    this.state = 'edit';
                },
             },
            created() {
                //let today = new Date.now();
                //this.reportEnd = this.timestampToYMD(today);

                axios.get('/farm_asset.json?type=planting').then(response => {
                    this.crops = response.data.list.map(f => f.name).sort();
                    this.crops.splice(0,0,"All");
                });

                //let today = new Date.now();
                //this.reportEnd = this.timestampToYMD(today);
            }
        });
       Vue.config.devtools = true;
    </script>
</body>