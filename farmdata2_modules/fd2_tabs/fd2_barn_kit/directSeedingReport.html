<head>
    <h1>Direct Seeding Report</h1>
</head>
<body>
  <div id="DSReport">
      <br>
      <label for ="DatesFrom">Date From:</label>
      <input type="date" id="DatesFrom" name="date" value="2021-04-06" min="1980-01-01" max="2021-04-11" v-model="rptStart">
      <br>
      <label for ="DatesTo">Date To:</label>
      <input type="date" id="DatesTo" name="date" value="2021-04-06" min="2020-01-01" max="2021-04-11" v-model="rptEnd">
      <br>
      <label for ="CropsList">Crop(s):</label>
      <select id="CropsList" name="cropType" v-model="rptCrop">
          <option>All</option>
          <option v-for="crop in crops">{{crop}}</option>
      </select>
      <br>
      <label for ="FieldsList">Field(s):</label>
      <select id="FieldsList" name="fieldType" v-model="rptField">
          <option>All</option>
          <option v-for="field in fields">{{field}}</option>
      </select>
      <br><br>
        <button type="button" class="btn btn-primary" id="generate-report" @click="generateBtn">Generate Report</button>
        <hr>
        <div v-if="state=='visible'">
                <h1>Direct Seeding Report</h1>
                <br><br>
                <table border=1>
                    <tr>
                        <th v-for="TH in tableHeaders">{{TH}}</th>
                    </tr>
                    <tr v-for="(log,index) in tableLogs">
                        <td>{{log.Date}}</td>
                        <td>{{log.Crop}}</td>
                        <td>{{log.Field}}</td>
                        <td>{{log.Bed_Feet}}</td>
                        <td>{{log.RowsPerBed}}</td>
                        <td>{{log.Row_Feet}}</td>
                        <td>{{log.Hours}}</td>
                        <td>{{log.Annual}}</td>
                        <td>{{log.Comments}}</td>
                        <td>{{log.User}}</td>
                    </tr>
                </table> 

            
        </div>
  </div>
  <script>
      var dsreportVue = new Vue({
          el: "#DSReport",
          data:{
              rptCrop:"",
              crops:[],
              rptField: "",
              fields: [],
              rptStart:'',
              rptEnd:'',
              state:'inVisible',
              tableHeaders:['Date', 'Crop', 'Field', 'Bed Feet', 'Rows/Bed', 'Row Feet', 'Hours', 'Annual', 'Comments', 'User'],
              tableLogs:[],
              //DSLogs should be empty once retrieving API is working
              DSLogs:[],
              url: '',

          },

          methods:{
            generateBtn: function(){
                this.makeURL();
                
                axios.get(this.url)
                .then(response => {
                    this.DSLogs = response.data.list.map(h =>{
                        return{
                            Date: this.timestampToYMD(h.timestamp),
                            Crop: h.name,
                        };
                    });
                });
                
                while(this.tableLogs.length < this.DSLogs.length){
                    this.state='visible';this.tableLogs.push(this.DSLogs[this.tableLogs.length])
                }
            },
            YMDToTimestamp: function (ymd) {
                let d = new Date(ymd);
                    return Math.round(
                        d.getTime() / 1000 + new Date().getTimezoneOffset() * 60
                    );
            },

            timestampToDate: function(timestamp){
                return new Date(timestamp * 1000)
            },

            timestampToYMD: function (timestamp) {
                    let d = this.timestampToDate(timestamp);
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
            },

            makeURL: function (){
                let tss = this.YMDToTimestamp(this.rptStart)
                    let tse = this.YMDToTimestamp(this.rptEnd)
                if (this.rptCrop == 'All'){
                    if(this.rptStart == '' && this.rptEnd == ''){
                        this.url = '/log.json?type=farm_seeding'
                    } else if (this.rptStart == ''){
                    this.url = '/log.json?type=farm_seeding&timestamp[le]='+tse
                    }else if (this.rptEnd == ''){
                         this.url = '/log.json?type=farm_seeding&timestamp[ge]='+tss
                    } else {
                        this.url = '/log.json?type=farm_seeding&timestamp[ge]='+tss+'timestamp[le]='+tse
                    }
                } else {
                    let seedName = this.rptCrop;
                    if(this.rptStart == '' && this.rptEnd == ''){
                        this.url = '/log.json?type=farm_seeding&name=Seed '+seedName
                    } else if (this.rptStart == ''){
                        this.url = '/log.json?type=farm_seeding&name=Seed '+seedName+'&timestamp[le]='+tse
                    }else if (this.rptEnd == ''){
                         this.url = '/log.json?type=farm_seeding&name=Seed '+seedName+'&timestamp[ge]='+tss
                    } else {
                        this.url = '/log.json?type=farm_seeding&name=Seed '+seedName+'&timestamp[ge]='+tss+'&timestamp[le]='+tse
                    }


                }
            }

            
              


        },

          created(){
              axios.get("/farm_asset.json?type=planting").then(response=>{
                  this.crops = response.data.list.map(f =>f.name).sort();
              });

              axios.get("/taxonomy_term.json?area_type=field")
            .then(response => {
                this.fields = response.data.list.map(f => f.name).sort();
            }
            ).catch(error => {
                this.fields = ['Service Unavailable'];
                console.log(error)
            });
          }


      });
      Vue.config.devtools=true;
  </script>
</body>