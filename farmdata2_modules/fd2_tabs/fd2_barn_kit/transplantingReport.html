<div id="transplantUI" v-cloak> 

<!--fieldset groups together the heading, date input, and generate report button (styles are duplicated from the Seeding Report tab)-->
    <fieldset class="panel panel-default center-block" style="width: 50%;">
        <legend class="panel-heading" style="background-color: #d62a17; color: white;">Set Dates</legend>
        <div style="display: flex;width: 100%; padding: 7px">

        <!--This uses the dateRangeSelectionComponent defined in the FD2 Resources file - it defines the date input forms together.-->
            <date-range-selection data-cy="date-range-selection"
            class="center-block"  
            default-start-date="2020-05-05" :default-end-date=dateRangeMaxDate @start-date-changed="startDateChange" @end-date-changed="endDateChange" 
            >
            </date-range-selection>

            <!--Generate Report Button - uses the standard FD2 button style.-->
            <button data-cy="generate-rpt-btn" class="btn center-block btn-primary" @click="reportButtonClicked">Generate Report</button>
        </div>
     </fieldset>
     <!--Report table filters UI (uses the DropdownWithAllComponent defined in the fd2_tabs/resources directory) and the styles from the Seeding Report-->
     <fieldset class="center-block panel panel-default" style="width: 75%;" v-if="reportDisplay">
        <legend class="panel-heading" style="background-color: #d62a17; color: white;">Filters</legend>
         <div style="display: flex; width: 100%;">
            <dropdown-with-all data-cy="crop-dropdown" class="center-block" :dropdown-list=cropList includes-all default-input='All' @selection-changed="cropChange">Crop:</dropdown-with-all>
            <dropdown-with-all data-cy="area-dropdown" class="center-block" :dropdown-list=areaList includes-all default-input='All' @selection-changed="areaChange">Area:</dropdown-with-all>
         </div>   
     </fieldset>  

    <br>
    <br>

    <div v-if="reportDisplay">
        <custom-table data-cy="report-table"
                can-delete
                can-edit
                :headers="columns"
                :rows="harvestReportRows"
                :visible-columns="tableVisibleColumns">
        </custom-table>        
    </div>
</div>
<script>
    new Vue({
        el: '#transplantUI',
        components: {
            'date-range-selection': DateRangeSelectionComponent, 
            'dropdown-with-all': DropdownWithAllComponent,
            'custom-table': CustomTableComponent               
        },
        data: {
            //variables for date range selection
            startDate: "2020-05-05",
            // endDate: dayjs().format("YYYY-MM-DD"),
            endDate: "2020-05-15",
            dateRangeClicks: 0,
            // dateRangeMaxDate: dayjs().format("YYYY-MM-DD"),
            dateRangeMaxDate: "2020-05-15",
            //display variables
            reportDisplay: false,
            //report table variables
            columns : ["Crop", "Area", "Tray Seeding Date", "Transplanting Date", "Days in Tray", "Rows/Bed", "Row Feet", "Trays", "Hours", "Comments", "User"],
            tableVisibleColumns : [true, true,true,true,true,true,true,true,true,true,true,true],
            //filter dropdown variables
            selectedCrop: "All",
            selectedArea: "All",
            results: [],
            idToCropMap: new Map()
        },
        methods: {
            //methods for date range selection
            startDateChange: function(newDate) {
                this.startDate = newDate
                console.log(this.startDate)
            },
            endDateChange: function(newDate) {
                this.endDate = newDate
                console.log(this.startDate)
            },
            reportButtonClicked: function(){
                this.reportDisplay = true
                //Converts selected date-times into unix date format
                let timestampStart = dayjs(this.startDate).unix()
                let timestampEnd= dayjs(this.endDate).unix()

                //Sets string for API request with correct start and end date
                requestString = "/log.json?type=farm_transplanting&timestamp[ge]=" + String(timestampStart) + "&timestamp[le]=" + String(timestampEnd)

                console.log(requestString)

                //getAllPages function in FarmOS returns the logs that the API request string fetches
                getAllPages(requestString, this.results)
                .then(() => {
                    console.log("Results processed correctly")
                    // All of the requested records have now been added to result.
                    // Additional processing can happen here if necessary,
                    // or then may be omitted.
                })
                .catch((err) => {
                    console.log("An error has occurred: " + String(err))
                })

                axios.get('/farm.json')
                .then((response) => {
                    console.log("Got Response")
                    console.log(response)

                })
                .catch((error) =>{
                    console.log("Error Occurred")
                    console.log(error)
                })
                //Code out here will run after the API call

            },   
            deleteItem: function(index){
                this.rows.splice(index, 1)
            },
            //methods for dropdown filters
            cropChange(selectedCrop){
                this.selectedCrop = selectedCrop
            },
            areaChange(selectedArea){
                this.selectedArea = selectedArea   
            },
            //parses a string for integer
        },
        computed: {
           //Returns a sorted list of the crops represented in the logs in the report table. This is based off of the cropList() property in seedingReport.html
            
            cropList(){
                let cropFilter = this.results.filter((x) => x)

                if(this.selectedArea != 'All'){
                    let areaFilter = cropFilter.filter((x) => x.movement.area[0].name === this.selectedArea)
                    cropArray = areaFilter.map(h => this.idToCropMap.get(h.data.crop_tid))
                }
                else{
                    cropArray = cropFilter.map(h=>this.idToCropMap.get(h.data.crop_tid))
                }

                let crops = new Set(cropArray)
                let newCropArray = Array.from(crops)
                console.log(newCropArray)
                return newCropArray.sort()
            },
            
            //Returns a sorted list of the areas represented in the logs in the report table. This is based off of the areaList() property in seedingReport.html
            
            areaList(){
                let areaFilter = this.results.filter((x) => x)

                if(this.selectedCrop != 'All'){
                    let cropFilter = areaFilter.filter((x) => this.idToCropMap.get(x.data.crop_tid) === this.selectedCrop)
                    areaArray = cropFilter.map(h => h.movement.area[0].name)
                }
                else{
                    areaArray = areaFilter.map(h => h.movement.area[0].name)
                }

                let areas = new Set(areaArray)
                let newAreaArray = Array.from(areas)
                console.log(newAreaArray)
                return newAreaArray.sort()
            },
            
            //This is currently copied from the API 2 activity form the earlier part of the semester - some of it should be replaced to parse the returned JSON string correctly.
            harvestReportRows() {
                //For calculating days elapsed
                const DAY = 1000 * 60 * 60 * 24

                let filterRows = this.results.filter((x) => x)

                if(this.selectedArea != 'All'){
                    filterRows = filterRows.filter((x) => x.movement.area[0].name === this.selectedArea)
                }
                if(this.selectedCrop != 'All'){
                    filterRows = filterRows.filter((x) => this.idToCropMap.get(x.data.crop_tid) === this.selectedCrop)
                }

                let $vm = this
                let rows = filterRows.map(function(h) {
                    return{
                        id: h.id,
                        data: [
                            $vm.idToCropMap.get(h.data.crop_tid),
                            h.movement.area[0].name,
                            dayjs.unix(h.created).format('YYYY-MM-DD'),
                            dayjs.unix(h.changed).format('YYYY-MM-DD'),
                            Math.round((h.changed-h.created)/DAY),
                            h.quantity[0].value,
                            h.quantity[1].value,
                            h.quantity[2].value,
                            h.quantity[3].value,
                            h.notes.value,
                            h.uid.id
                        ]
                    }                    
                })

                return rows
            }
        },
        created(){
            //Creates a map that is able to convert crop ids to the crop name from the JSON string.
            getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap=theMap
                    console.log("crop map created")
                })
                .catch((err) => {
                    console.log("An error occurred in getting the IDToCropMap.")
                    console.log(err)
                })
        }
    })
    Vue.config.devtools = true;
</script>
