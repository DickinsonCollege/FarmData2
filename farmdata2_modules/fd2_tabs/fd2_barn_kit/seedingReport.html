<body>
    <div id="seedingReport" v-cloak>
        <h1 class="text-center">Seeding Report</h1>
        <div class="center-block">
            <fieldset class="panel panel-default center-block" style="width: 50%;">
                <legend class="panel-heading" style="background-color: #d9edf7;">Set Dates</legend>
                <div style="display: flex;width: 100%">
                    <date-range-selection class="center-block"  @start-date-changed='startDateChange' @end-date-changed='endDateChange' :default-start-date=startDate :default-end-date=endDate></date-range-selection>

                    <button class="center-block btn-info" v-if='!inputsVisible' @click='seedingLogRequestWithDates'>Generate Report</button>
                </div>
            </fieldset>
        </div>
        <div v-if='inputsVisible'>
            <fieldset class="center-block panel panel-default" style="width: 75%;">
                <legend class="panel-heading" style="background-color: #dff0d8">Filters</legend>
                <div style="display: flex; width: 100%;">
                    <dropdown-with-all class="center-block"  :dropdown-list=seedingList includes-all default-input='All' @selection-changed='seedingChange'>Type Of Seeding:</dropdown-with-all>
                
                    <dropdown-with-all class="center-block" :dropdown-list=cropList includes-all default-input='All' @selection-changed='cropChange'>Crop:</dropdown-with-all>

                    <dropdown-with-all class="center-block" :dropdown-list=areaList includes-all default-input='All' @selection-changed='areaChange'>Area:</dropdown-with-all> 
                </div>
            </fieldset>

            <custom-table :visible-columns='visibleColumns' :rows=tableRows :headers='headers' can-edit can-delete></custom-table>

            <br>
            
            <fieldset class="center-block panel panel-default">
                <legend class="panel-heading" style="background-color: #dff0d8">Direct Seeding Summary</legend>
                <p>Total Row/Bed Planted: {{ totalRowBed }}</p>
                <p>Total Row Feet Planted: {{ totalRowFeet }}</p>
                <p>Total Bed Feet Planted: {{ totalBedFeet }}</p>
                <p>Total Hours Worked: {{ totalDirectSeedingHours }}</p>
                <p>Total Bed Feet per Hour: {{ totalBedFeetPerHour }}</p>
                <p>Total Row Feet per Hour: {{ totalRowFeetPerHour }}</p>
            </fieldset>
            <fieldset class="center-block panel panel-default">
                <legend class="panel-heading" style="background-color: #dff0d8">Tray Seeding </legend>
                <p>Total number of Tray Seeds Planted: {{ traySeedsPlanted }}</p>
                <p>Total number of Trays: {{ totalNumTrays }}</p>
                <p>Total Hours Worked: {{ totalTraySeedingHours }}</p>
                <p>Average Seeds Planted per Hour: {{ aveSeedsPerHour }}</p>
            </fieldset>
        </div>
    </div>
    <script>
        var seedingReport = new Vue ({
            el: '#seedingReport',
            components: {
                'custom-table': CustomTableComponent,
                'date-range-selection': DateRangeSelectionComponent,
                'dropdown-with-all': DropdownWithAllComponent
            },
            data: {
                startDate:'2020-05-01',//dayjs().startOf('year').format('YYYY-MM-DD').toString(),
                endDate: dayjs().format('YYYY-MM-DD').toString(),
                inputsVisible: false,
                seedingLogs: [],
                sessionToken: null,
                selectedCrop: 'All',
                selectedArea: 'All',
                selectedSeeding: 'All',
                headers: ['date', 'crop', 'area', 'Tray/Direct', 'Row/Bed', 'Row Feet', 'Bed Feet', 'Tray Seeds', '# of Trays', 'Cells Per Tray', 'Hours', 'Num of Workers','Varieties', 'Comments','User'],
                visibleColumns: [true, true, true, true, false, false, false, false, false, false, true, true, true, true, true],
                IDToCropMap: new Map(),
                idToUserMap: new Map(),
                bedFeet: 0,
            },
            methods: {
                startDateChange(selectedDate){
                    this.startDate = selectedDate
                    this.inputsVisible = false
                    this.seedingLogs = []
                },
                endDateChange(selectedDate){
                    this.endDate = selectedDate
                    this.inputsVisible = false
                    this.seedingLogs = []
                },
                seedingLogRequestWithDates(){
                    this.inputsVisible = true
                    let link = '/log.json?type=farm_seeding&timestamp[ge]=' + dayjs(this.startDate).unix() + '&timestamp[le]=' + dayjs(this.endDate).unix()

                    getAllPages(link, this.seedingLogs)
                },
                cropChange(selectedCrop){
                    this.selectedCrop = selectedCrop
                },
                areaChange(selectedArea){
                    this.selectedArea = selectedArea
                },
                seedingChange(selectedSeeding){
                    this.selectedSeeding = selectedSeeding
                    if(selectedSeeding == 'All'){
                        this.visibleColumns = [true, true, true, true, false, false, false, false, false, false, true, true, true, true, true]
                    }
                    else if(selectedSeeding == 'Direct Seedings'){
                        this.visibleColumns = [true, true, true, true, true, true, true, false, false, false, true, true, true, true, true]
                    }
                    else if(selectedSeeding == 'Tray Seedings'){
                        this.visibleColumns = [true, true, true, true,false, false, false, true, true, true,  true, true, true, true, true]
                    }
                }
            },
            computed: {
                tableRows() {
                    let filterRows = this.seedingLogs.filter((x) => x)

                    if(this.selectedArea != 'All'){
                        filterRows = filterRows.filter((x) => x.movement.area[0].name === this.selectedArea)
                    }
                    if(this.selectedCrop != 'All'){
                        filterRows = filterRows.filter((x) => this.IDToCropMap.get(JSON.parse(x.data).crop_tid) === this.selectedCrop)
                    }
                    if(this.selectedSeeding != 'All'){
                        filterRows = filterRows.filter((x) => x.log_category[0].name === this.selectedSeeding)
                    }
                    let $vm = this
                    let rows = filterRows.map(function(h) {
                        let rowBed = 0
                        let rowFeet = 0
                        let bedFeet = 0
                        let traySeeds = 0
                        let numOfTrays = 0
                        let cellsPerTray = 0
                        let hours = 0
                        let numWorker = 0
                        if(h.log_category[0].name === 'Direct Seedings'){
                            rowBed = h.quantity[1].value
                            rowFeet = h.quantity[0].value
                            bedFeet = rowFeet/rowBed
                            hours = h.quantity[2].value
                            numWorkers = h.quantity[3].value
                        }
                        else{
                            traySeeds = h.quantity[0].value
                            numOfTrays = h.quantity[1].value
                            cellsPerTray = h.quantity[2].value
                            hours = h.quantity[3].value
                            numWorkers = h.quantity[4].value
                        }
                        return{
                            id: h.id,
                            data: [
                                dayjs.unix(h.timestamp).format('YYYY-MM-DD'),
                                $vm.IDToCropMap.get(JSON.parse(h.data).crop_tid),
                                h.movement.area[0].name, 
                                h.log_category[0].name, 
                                rowBed,
                                rowFeet,
                                bedFeet,
                                traySeeds,
                                numOfTrays,
                                cellsPerTray,
                                hours,
                                numWorkers,
                                h.lot_number,
                                h.notes.value,
                                $vm.idToUserMap.get(h.uid.id)
                            ]
                        }
                    })
                    return rows
                },
                cropList(){
                    let seedFilter = []
                    if(this.selectedSeeding != 'All'){
                        seedFilter = this.seedingLogs.filter((x) => x.log_category[0].name === this.selectedSeeding)
                    }
                    else{
                        seedFilter = this.seedingLogs.filter((x) => x)
                    }
                    let cropArray = []
                    if(this.selectedArea != 'All'){
                        let areaFilter = seedFilter.filter((x) => x.movement.area[0].name === this.selectedArea)
                        cropArray = areaFilter.map(h => 
                            this.IDToCropMap.get(JSON.parse(h.data).crop_tid)
                        )
                    }
                    else{
                        cropArray = seedFilter.map(h=> 
                            this.IDToCropMap.get(JSON.parse(h.data).crop_tid)
                        )
                    }

                    let crops = new Set(cropArray)
                    let newCropArray = Array.from(crops)
                    return newCropArray.sort()
                },
                areaList(){
                    let seedFilter = []
                    if(this.selectedSeeding != 'All'){
                        seedFilter = this.seedingLogs.filter((x) => x.log_category[0].name === this.selectedSeeding)
                    }
                    else{
                        seedFilter = this.seedingLogs.filter((x) => x)
                    }
                    let areaArray = []
                    if(this.selectedCrop != 'All'){
                        let cropFilter = seedFilter.filter((x) => this.IDToCropMap.get(JSON.parse(x.data).crop_tid) === this.selectedCrop)
                         areaArray = cropFilter.map(h =>
                            h.movement.area[0].name
                        )
                    }
                    else{
                        areaArray = seedFilter.map(h =>
                            h.movement.area[0].name
                        )
                    }
                    let areas = new Set(areaArray)
                    let newAreaArray = Array.from(areas)
                    return newAreaArray
                },
                seedingList(){
                    let areaFilter = []
                    if(this.selectedArea != 'All'){
                        areaFilter = this.seedingLogs.filter((x) => x.movement.area[0].name === this.selectedArea)
                    }
                    else{
                        areaFilter = this.seedingLogs.filter((x) => x)
                    }
                    let seedingArray = []
                    if(this.selectedCrop != 'All'){
                        let cropFilter = areaFilter.filter((x) => this.IDToCropMap.get(JSON.parse(x.data).crop_tid) === this.selectedCrop)
                        seedingArray = cropFilter.map(h =>
                            h.log_category[0].name
                        )
                    }
                    else{
                        seedingArray = areaFilter.map(h => 
                            h.log_category[0].name
                        )
                    }
                    let seedings = new Set(seedingArray)
                    let newSeedingArray = Array.from(seedings)
                    return newSeedingArray
                },
                totalRowBed(){
                    let tableData = this.tableRows
                    
                    let sumRowBed = 0
                    tableData.map(h => {
                        sumRowBed = sumRowBed + parseInt(h.data[4])
                    })

                    return sumRowBed
                },
                totalRowFeet(){
                    let tableData = this.tableRows
                    let sumRowFeet = 0
                    tableData.map(h => {
                        sumRowFeet = sumRowFeet + parseInt(h.data[5])
                    })
                    return sumRowFeet
                },
                totalBedFeet(){
                    let tableData = this.tableRows
                    let sumBedFeet = 0
                    tableData.map(h => {
                        sumBedFeet = sumBedFeet + parseInt(h.data[6])
                    })
                    return sumBedFeet
                },
                totalDirectSeedingHours(){
                    let tableData = this.tableRows
                    let filteredTableData = tableData.filter((x) => x.data[3] === 'Direct Seedings')
                    let sumHours = 0
                    filteredTableData.map(h => {
                        sumHours = sumHours + (parseFloat(h.data[10])*parseFloat(h.data[11]))
                    })
                    return sumHours
                },
                totalBedFeetPerHour(){
                    let bedFeet = this.totalBedFeet
                    let hours = this.totalDirectSeedingHours
                    return bedFeet/hours
                },
                totalRowFeetPerHour(){
                    let rowFeet = this.totalRowFeet
                    let hours = this.totalDirectSeedingHours
                    return rowFeet/hours
                },
                traySeedsPlanted(){
                    let tableData = this.tableRows
                    let totalTraySeeds = 0
                    tableData.map(h =>
                       totalTraySeeds = totalTraySeeds + parseFloat(h.data[7])
                    )
                    return totalTraySeeds
                },
                totalNumTrays(){
                    let tableData = this.tableRows
                    let totalTrays = 0
                    tableData.map(h =>
                       totalTrays = totalTrays + parseFloat(h.data[8])
                    )
                    return totalTrays
                },
                totalTraySeedingHours(){
                    let tableData = this.tableRows
                    let filteredTableData = tableData.filter((x) => x.data[3] === 'Tray Seedings')
                    let sumHours = 0
                    filteredTableData.map(h => {
                        sumHours = sumHours + (parseFloat(h.data[10])*parseFloat(h.data[11]))
                    })
                    return sumHours
                },
                aveSeedsPerHour(){
                    let seedsPlanted = this.traySeedsPlanted
                    let hours = this.totalTraySeedingHours
                    return seedsPlanted/hours
                }
            },
            created() {
                getSessionToken().then((response) => {
                    this.sessionToken = response
                })
                getIDToCropMap().then((response) => {
                    this.IDToCropMap = new Map(response)
                })
                getIDToUserMap().then((response) => {
                    this.idToUserMap = new Map (response)
                })
            },
        });
        Vue.config.devtools = true;
    </script>
</body>