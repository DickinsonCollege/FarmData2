<!-- define a div to wrap around the app. -->
<!-- apply v-cloak so that app is not visible until after being rendered -->
<div id="api" v-cloak> 

    <p>The farmdata2_modules/FarmData2/fd2_tabs/resources/FarmOSAPI.js file provide a library of JavaScript convenience functions for accessing the FarmOS API.  This page gives examples of how to use these functions to interact with the farmOS databse (E.g. fetch, create, update and delete logs). The js library is included in the page by the fd2_example.info file.</p>

    <p><b>Get Farm Info</b></p>
    <p>The button below fetches information about the farm and displays a few pieces of it.
    </p>
    <UL>
        <button data-cy='get-farm-info' @click='fetchFarmInfo'>Fetch Farm Info</button>
        <button data-cy='clear-farm-info' @click='farmInfo = null'>Clear</button>
        <p>Results:</p>
        <UL>
            <LI>Farm Name: <span data-cy='farm-name'>{{ farmName }}</span></LI>
        </UL>
    </UL>

    <p><b>Fetching Logs</b></p>
    <p>The button below fetches the seeding logs from May 1, 2020 through May 5, 2020 and displays the dates, crops and locations where the crops that were seeded.</p>
    <UL>
        <button data-cy='fetch-seedings' @click='fetchSeedingLogs'>Fetch Logs</button>
        <button data-cy='clear-seedings' @click='seedingLogs = []'>Clear</button>
        <p>Result:</p>
        <UL>
            <table border=1px>
                <tr><th>Date</th><th>Crop</th><th>Area</th></tr>
                <tr v-for="(log,i) in seedingLogs">
                    <td :data-cy=i+'date'>{{ dayjs.unix(log.timestamp).format("YYYY/MM/DD") }}</td>
                    <td :data-cy=i+'crop'>{{ idToCropMap.get(JSON.parse(log.data).crop_tid) }}</td>
                    <td :data-cy=i+'area'>{{ log.movement.area[0].name }}</td>
                </tr>
            </table>
        </UL>
    </UL>

    <p><b>Creating/Updating/Deleting an Asset</b></p>
    <p>The buttons below illustrate how to create, update and delete assets (logs are similar just with a differnt url). The "Make New Asset" button creates a new planting asset for a BEET on today's date by manager1.  The "Update Asset" toggles the planting between BEET and SPINICH.  The "Delete Asset" removes the asset from the database.</p>
    <UL>
        <button data-cy='create-planting' :disabled='plantedCrop!=null' @click='makePlantingAsset'>Make New Asset</button>
        <button data-cy='update-planting' :disabled='plantedCrop==null' @click='updatePlantingAsset'>Update Asset</button>
        <button data-cy='delete-planting' :disabled='plantedCrop==null' @click='deletePlantingAsset'>Delete Asset</button>
        <p>Result:</p>
        <UL>
            <LI>Planting Asset ID: <span data-cy=planting-id>{{ plantingID }}</span>
            <LI>Status: <span data-cy=planting-status>{{ plantingAssetStatus }}</span></LI>
            <LI>Response: <span data-cy=planting-response>{{ plantingAssetResponse }}</span></LI>
        </UL>
    </UL>

    <p>The api.spec.js file contains examples of how to test the content of this page.</p>
</div>

<script>
// Define the Vue instance for the app.
new Vue({
    el: '#api',  // el: must match the id of the <div> for the app above.
    data: {
        // Provide easy access to the FarmDat2 variables in vue.
        // Note: 
        //   The JS variables fd2UserID and fd2UserName are defined in the fd2_example.module file.
        //   They are also defined in the fd2_barn_kit and fd2_field_kit so are avaiable there as well. 
        userID: fd2UserID,
        userName: fd2UserName,

        idToCropMap: new Map(),
        cropToIDMap: new Map(),

        farmInfo: null,
        
        seedingLogs: null,

        sessionToken: null,
        plantingAssetStatus: null,
        plantingAssetResponse: null,
        plantingID: null,
        plantedCrop: null,
    },
    methods: {
        fetchFarmInfo() {
            // Uses axios directly to fetch the farm info.  The object that is returned
            // in the response.data is placed into the farmInfo variable. That variable
            // is used by the farmName and farmURL computed properties to provide the 
            // value that is rendered in the page.
            axios
            .get('/farm.json')
            .then((response) => {
                this.farmInfo = response.data
            })
            .catch((error) => {
                this.farmInfo = error
            })
        },
        fetchSeedingLogs() {
            start = dayjs("2020-05-01","YYYY-MM-DD")
            // Add 1 day here to get to the end of May 5th.
            end = dayjs("2020-05-05","YYYY-MM-DD").add(1,'day')

            startUnix = start.unix()
            endUnix = end.unix()

            this.seedingLogs = []
            getAllPages('/log.json?type=farm_seeding&timestamp[gt]='+startUnix+'&timestamp[lt]='+endUnix, this.seedingLogs)
        },
        makePlantingAsset() {
            let planting = {
                "name": dayjs().format("YYYY-MM-DD") + " BEET  ALF-1",
                "type": "planting",
                "crop": [{
                    "id": this.cropToIDMap.get("BEET"),
                    "resource": "taxonomy_term"
                }],
            }
            createRecord('/farm_asset', planting, this.sessionToken).then((response) => {
                this.plantingAssetStatus = response.status
                this.plantingAssetResponse = response.data
                this.plantedCrop = "BEET"
                this.plantingID = this.plantingAssetResponse.id
            })
        },
        updatePlantingAsset() {
            let update = {
                "crop": [{
                    "id": this.cropToIDMap.get("BEET"),
                    "resource": "taxonomy_term"
                }],
            }

            if (this.plantedCrop == "BEET") {
                update.crop[0].id = this.cropToIDMap.get("SPINACH")
                this.plantedCrop = "SPINACH"
            }
            else {
                this.plantedCrop = "BEET"
            }
            
            let url = '/farm_asset/' + this.plantingID
            updateRecord(url, update, this.sessionToken).then((response) => {
                this.plantingAssetStatus = response.status
                this.plantingAssetResponse = response
            })
        },
        deletePlantingAsset() {
            let url = '/farm_asset/' + this.plantingID
            deleteRecord(url, this.sessionToken).then((response) => {
                this.plantingAssetStatus = response.status
                this.plantingAssetResponse = response
                this.plantedCrop = null
                this.plantingID = null
            })
        }
    },
    computed: {
        farmName() {
            if (this.farmInfo == null) {
                return "";
            }
            else {
                return this.farmInfo.name;
            }
        },
    },
    created() {
        getIDToCropMap().then((response) => {
            this.idToCropMap = response
        })
        getCropToIDMap().then((response) => {
            this.cropToIDMap = response
        })
        getSessionToken().then((response) => {
            this.sessionToken = response
        })
    }
})

//Allows Vue to be accessed in Dev Tools
Vue.config.devtools = true;
</script>
    