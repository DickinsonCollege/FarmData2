<!DOCTYPE html>
<head>
    <title>A06 Sub-Tab</title>
    <style>
        table, th, tr{
            border: 1px solid black;
            table-layout: fixed;
        }
        td {
            border: 1px solid black;  
            width: 25%;
        }
    </style>
</head>
<body>
    <div id="report">
    <h1>Harvest Report</h1>
    <p>This page is a <i>mockup</i> of a form for generating a harvest report.</p>
    <div>
        <label for="reportTitle">Title: </label>
        <input type="text" placeholder="My Mock Report" v-model="reportTitle">
    </div>
    <div>
        <label for="crop">Crop: </label>
        <select v-model="reportCrop"> 
            <option v-for="crop in crops">{{crop}}</option>
        </select>

        <label for="field">Field: </label>
        <select v-model="reportField">
            <option v-for="field in fields">{{field}}</option>
        </select>
    </div>
    <div>
        <label for="start">Start:</label>
        <input type="date" id="start" min="2014-01-01" :max="reportEndDate" value="2018-05-01" v-model="reportStartDate">

        <label for="end">End:</label>
        <input type="date" id="end" :min="reportStartDate" max="2022-01-01" value="2018-05-15" v-model="reportEndDate">
    </div>
    <br>
    <button type="button" v-model="logIndex" @click="setTableState('show'), getHarvestRequest(reportField), console.log(reportField)">Generate Report</button>
    <hr>
    <!-- <h1>My Mock Report</h1> -->
    <div id="reportTableSection" v-if="tableState === 'show'">
        <div v-cloak>
            <h1>{{reportTitle ? reportTitle : 'Mock Harvest Report'}}</h1>
        </div>
        <br>
        <p>Details:</p>
        <br>
        <ul>
            <li><strong>Start: {{reportStartDate}}</strong></li>
            <li><strong>End: {{reportEndDate}}</strong></li>
            <li><strong>Crop: {{reportCrop}}</strong></li>
            <li><strong>Field: {{reportField}}</strong></li>
        </ul>
        <table>
            <p v-if="reportHarvestLogs.length == 0">No matching records currently.</p>
            <tr v-if="reportHarvestLogs.length !== 0">
                <th>Date</th>
                <th>Field</th>
                <th>Crop</th>
                <th>Yield</th>
                <th>Delete</th>
            </tr>
            <tr v-for="(data, dataIndex) in reportHarvestLogs">
                    <td>{{data.date}}</td>
                    <td>{{data.field}}</td>
                    <td>{{data.crop}}</td>
                    <td>{{data.yield}}</td>
                    <td><button @click="deleteHarvestLog(dataIndex)">Delete</button></td>
                </tr>
            </table>
            <p>Total yield: {{computeTotalYield}}</p>
        </div>
    </div>
    <script>
        var report = new Vue({
          el: '#report',
          data:{
            reportTitle: '',
            reportStartDate: '2018-05-01',
            reportEndDate: '2018-05-15',
            reportCrop: 'Broccoli',
            reportField: '',
            crops: [], 
            fields: [],
            reportHarvestLogs: [],
            logIndex: 0,
            tableState: 'hide',
            harvestLogsAvailable: false,
            harvestRequest: "`/log.json?type=farm_harvest&area=${this.reportField}`"
          },
          methods: {
              addHarvestLogs: function(index){
                  if (this.logIndex < log.length){
                    this.reportHarvestLogs.push(log[this.logIndex]);
                    this.logIndex+=1;
                  } else {
                      console.log('Out of record');
                  }
              },
              deleteHarvestLog: function(dataIndex){
                this.reportHarvestLogs.splice(dataIndex, 1);
              },
              setTableState: function(state){
                  this.tableState = state;
              },
              timestampToDate: function(timestamp) {
                return new Date(timestamp * 1000);
              },
              timestampToYMD: function(timestamp) {
                let d = this.timestampToDate(timestamp);
                const month = d.getMonth() < 9 ?
                                '0' + (d.getMonth() + 1) :
                                d.getMonth() + 1;
                const day = d.getDate() < 10 ?
                            '0' + d.getDate() :
                                d.getDate();
                return d.getFullYear() + "-" + month + "-" + day;
            },
                getCropName: function(string){
                    let splitString =  string.split(' ')
                    return splitString[splitString.length - 1]
                },

                getHarvestRequest: function(reportField){
                    axios.get('/log.json?type=farm_harvest&area=' + reportField)
                    .then(response => {
                    this.reportHarvestLogs = response.data.list.map(log => {
                    return {
                        date: this.timestampToYMD(log.timestamp),
                        field: log.area[0].name,
                        crop: this.getCropName(log.name),
                        yield: log.quantity[0].value
                    }
                })
                }
            )
                }
          },
          computed: {
              computeTotalYield: function(){
                  let totalYield = 0
                  for (let i = 0; i < this.reportHarvestLogs.length; i++){
                    let yield = parseInt(this.reportHarvestLogs[i].yield.split(" ")[0])
                    totalYield += yield
                  }
                  return totalYield;
              },
              getRequestURL: function(){
                  return `/log.json?type=farm_harvest&area=${this.reportField}`
              }
          },
          created() {
            axios.get('/taxonomy_term.json?area_type=field')
            .then(response => {
                this.fields = response.data.list.map(f => f.name).sort();
            }
            ).catch(error => {
                this.fields = ['Service Unavailable'];
                console.log(error)
            });

            axios.get('/farm_asset.json?type=planting')
            .then(response => {
                this.crops = response.data.list.map(f => f.name).sort();
            }
            ).catch(error => {
                this.crops = ['Service Unavailable'];
                console.log(error)
            });

            // axios.get(this.getRequestURL)
            // .then(response => {
            //     this.reportHarvestLogs = response.data.list.map(log => {
            //         return {
            //             date: this.timestampToYMD(log.timestamp),
            //             field: log.area[0].name,
            //             crop: this.getCropName(log.name),
            //             yield: log.quantity[0].value
            //         }
            //     })
            //     }
            // )
            },
        },
            
        );
        Vue.config.devtools = true;
    </script>
</body>