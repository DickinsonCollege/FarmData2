<body>
    <h1>Harvest Report</h1>
    <br>
        <p>This page is a mock-up of a form for generating a harvest report</p>

        <div id="mock_report" v-cloak>
            
            <label for="title">Title:</label>
            <input type="text" v-model="header">

            <br>

            <label for="start">Start:</label>
            <input type="date" id="start" name="start" v-model="reportStart" min="2014-01-01" :max="reportEnd">

            <label for="end">End:</label>
            <input type="date" id="end" name="end" v-model="reportEnd" :min="reportStart" max="2022-01-01">
            
            <br>

            <label for="crop">Crop:</label>
            <select id="crop" name="crop" v-model="reportCrop">
                <option v-for="cropOption in cropList">{{ cropOption }}</option>
            </select>

            <label for="field">Field:</label>
            <select id="field" name="field" v-model=selectedField>
                <option v-for="fieldOption in fieldList">{{ fieldOption }}</option>
            </select>

            <br>

            <button class="btn btn-primary" @click="generateReport(); changeReportVisibility('visible'); fieldLogRequest(selectedField);">Generate Report</button>

            <hr>

            <div v-if="reportVisibility === 'visible'" class="reportSection">
                <h2>{{ header ? header:"Mock Harvest Report" }}</h2>
                    <br>
                    <ul>
                    <li><strong>Start:</strong> {{reportStart}}</li>
                    <li><strong>End:</strong> {{reportEnd}}</li>
                    <li><strong>Crop:</strong> {{reportCrop}}</li>
                    </ul>

                <br>

                <p v-if="harvestLogs.length === 0">There are no matching harvest logs.</p>
                <table v-if="harvestLogs.length !== 0" border=1>
                    <tr>
                        <th>Date</th>
                        <th>Field</th>
                        <th>Crop</th>
                        <th>Yield</th>
                        <th>Delete</th>
                    </tr>
                    <tr v-for="log in harvestLogs">
                        <td>{{ timestampToYMD(log.date) }}</td>
                        <td>{{log.field}}</td>
                        <td>{{log.crop}}</td>
                        <td>{{log.yield}}</td>
                        <td>
                            <button type="button" @click="deleteReport">Delete</button>
                        </td>
                    </tr>
                </table>
                <p>Total Yield: {{ getTotalYield }}</p>
            </div>
        
        </div>

        <script>
            var mockReport = new Vue({
                el: '#mock_report',
                data: {
                    reportVisibility: "hidden",
                    header: 'My Mock Report',
                    reportStart: '2018-05-01',
                    reportEnd: '2018-07-31',
                    reportCrop: 'Broccoli',
                    selectedField: '',
                    cropList: [
                        'Broccoli',
                        'Kale',
                        'Peas'
                    ],
                    fieldList: [
                        'All',
                        'Chuau',
                        'SQ7",'
                    ],
                    newHarvestLog: '',
                    harvestLogs: [
                        
                    ]
                },
                computed: {
                    getTotalYield() {
                        let totalYield = 0;
                        for(let i = 0; i < this.harvestLogs.length; i++) {
                            let log = this.harvestLogs[i];
                            totalYield = totalYield + parseInt(log.yield.split(" ")[0]);
                        }
                        return totalYield;
                    }
                },
                methods: {
                    generateReport: function() {
                        
                        if(this.harvestLogs.length == 0) {
                            this.harvestLogs.push({date: '05/02/2018', field: 'SQ7', crop: 'Kale', yield: '7 bunches', index: 0});
                        }
                        else if(this.harvestLogs.length == 1) {
                            this.harvestLogs.push({date: '05/03/2018', field: 'Chuau', crop: 'Kale', yield: '10 bunches', index: 1});
                        }
                        else {
                            //do nothing
                        }
                    },
                    deleteReport: function(logIndex) {
                        this.harvestLogs.splice(logIndex,1);
                    },
                    changeReportVisibility: function(newVisibility) {
                        this.reportVisibility = newVisibility;
                    },
                    fieldLogRequest: function(field) {
                        let s = this.YMDToTimestamp(this.reportStart);
                        let e = this.YMDToTimestamp(this.reportEnd);
                        axios.get('/log.json?type=farm_harvest&area=' +  field + '&timestamp[ge]=' + s + '&timestamp[le]=' + e)
                            .then(response => {
                                this.harvestLogs = response.data.list.map(h => {
                                    return {
                                        date:h.timestamp,
                                        field:h.area[0].name,
                                        crop:h.name.split(" ")[4],
                                        yield:h.quantity[0].value + ' ' + h.quantity[0].unit.name,
                                    };
                                });
                            })
                    },
                    timestampToDate: function(timestamp) {
                        return new Date(timestamp * 1000);
                    }, 
                    timestampToYMD: function(timestamp) {
                        let d = this.timestampToDate(timestamp);
                        const month = d.getMonth() < 9 ?
                                     '0' + (d.getMonth() + 1) :
                                     d.getMonth() + 1;
                        const day = d.getDate() < 10 ?
                                 '0' + d.getDate() :
                                    d.getDate();
                        return d.getFullYear() + "-" + month + "-" + day;
                    }, 
                    YMDToTimestamp: function(ymd) {
                        let d = new Date(ymd);
                        return Math.round(d.getTime()/1000 +
                                new Date().getTimezoneOffset()*60);
                    },
                },
                created() {
                    axios.get('/taxonomy_term.json?area_type=field')
                        .then(response => {
                            this.fieldList = response.data.list.map(f => f.name);
                            this.fieldList = this.fieldList.sort();
                        })
                        .catch(error => {
                            console.log(error);
                        }
                    );
                    axios.get('/farm_asset.json?type=planting')
                        .then(response => {
                            this.cropList = response.data.list.map(c => c.name);
                            this.cropList = this.cropList.sort();
                        })
                        .catch(error => {
                            console.log(error);
                        }
                    );
                }
            });
            Vue.config.devtools = true;
        </script>
</body>