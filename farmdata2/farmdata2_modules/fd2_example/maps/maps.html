<!-- define a div to wrap around the app. -->
<!-- apply v-cloak so that app is not visible until after being rendered -->
<div id="maps" v-cloak> 

    <p>The farmdata2_modules/FarmData2/fd2_tabs/resources/FarmOSAPI.js file provide a library of JavaScript convenience functions for accessing the FarmOS API.  This page gives examples of how to use these functions for loading maps from farmOS id numbers to textual names and vice versa (E.g. from user id to user name or crop id to crop name). The js library is include in the page by the fd2_example.info file.</p>

    <p>This page specifcially demonstrates the maps for going from user id to username and vice versa. The use of other maps is similar.  The documentation for the maps can be viewed by opening farmdata2_modules/fd2_tabs/resources/doc/index.html from the repo in your browser.  You can find the full source for the library in farmdata2_modules/FarmData2/fd2_tabs/resources/FarmOSAPI.js.</p>
        
    <p>Examples of how to use Cypress to test the elements on this page can be found in the maps.spec.js file.</p>

    <p>The userToIDMap map can be used to go from a username to a user id:</p>
    <UL>
        <LI>The logged in user is {{ userName }}.</LI>
        <LI>That user's ID in the map is: 
            <span data-cy="mapped-id">{{ userToIDMap.get(userName) }}</span>
    </UL>

    <p>The IDToUserMap map can be used to go from a user id to a username:</p>
    <UL>
        <LI>The logged in user id is {{ userID }}.</LI>
        <LI>That user's name in the map is: 
            <!-- Need to convert userID to a string here because the map keys are strings -->
            <span data-cy="mapped-name">{{ idToUserMap.get(userID.toString()) }}</span>
    </UL>

    <p>The full list of users known to the sustem is:</p>
    <UL>
        <table border=1px>
            <tr><th>User ID</th><th>User Name</th></tr>
            <!-- Use the computed property sortedIDs here to order the output -->
            <!-- Also bind the data-cy attribute into the v-for index -->
            <!-- That gives each element in the table a unique data-cy for testing. -->
            <tr v-for='(id,i) in sortedIDs'>
                <td :data-cy=i+'id'>{{ id }}</td><td :data-cy=i+'name'>{{ idToUserMap.get(id) }}</td></tr>
        </table>
    </UL>

    <!-- This div is used by the Cypress tests to wait until all of the
         API calls initiated in the created() method have completed.  The
         pageLoaded value is set by a computed function that checks if the 
         required number of API calls have completed.  Each API call initiated
         in created() then increments the this.createdCount variable in data
         when the call completes (i.e. in its then()).  When all API calls have
         completed, the pageLoaded value becomes true.  This is then detected
         by the cy.waitForPage() function that is used in the test.  The 
         cy.waitForPage() function is defined in the cypress/support/commands.js
         file.
    -->
    <div data-cy="page-loaded" v-show=false>{{ pageLoaded }}</div>
</div>

<script>
// Define the Vue instance for the app.
new Vue({
    el: '#maps',  // el: must match the id of the <div> for the app above.
    data: {
        // Provide easy access to the FarmDat2 variables in vue.
        userID: fd2UserID,
        userName: fd2UserName,

        // Vue variables to hold the maps that are loaded from farmOS
        // Note: Making a new map here prevents null reference exceptions if the
        //       map has not been retrieved yet when the page is rendered.
        userToIDMap: new Map(),
        idToUserMap: new Map(),
        createdCount: 0,  // used in created and pageLoaded
    },
    computed: {
        sortedIDs() {
            keys = Array.from(this.idToUserMap.keys());
            keys.sort(function(a,b) { 
                return Number(a) - Number(b);
            })
            return keys
        },
        pageLoaded() {
            // Check here that the correct number of API calls have completed.
            return this.createdCount == 2
        },
    },
    created() {
        // Use the FarmData2 library functions to load the maps into the 
        // Vue variables when this page is created.
        getUserToIDMap().then((response) => {
            this.userToIDMap = response
            // Increment this in the then() of each API call.
            this.createdCount++
        })
        getIDToUserMap().then((response) => {
            this.idToUserMap = response
            // Increment this in the then() of each API call.
            this.createdCount++
        })
    }
})

//Allows Vue to be accessed in Dev Tools
Vue.config.devtools = true;
</script>
    