version: '2.2'
services:
  db:
    image: farmdata2/mariadb:fd2.1
    container_name: fd2_mariadb
    volumes:
      - farmos_db:/var/lib/mysql  # use a docker volume here for performance.
    ports:
      - '3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: farm
      MYSQL_DATABASE: farm
      MYSQL_USER: farm
      MYSQL_PASSWORD: farm

  farmos:
    depends_on:
      - db
    image: farmdata2/farmos:fd2.6
    container_name: fd2_farmdata2
    volumes:
      - './farmOS/settings.php:/var/www/html/sites/default/settings.php:delegated'
      - './logo:/var/www/html/sites/default/files:cached'
      - '../contrib_modules:/var/www/html/sites/all/modules/contrib_modules:cached'
      - '../farmdata2_modules:/var/www/html/sites/all/modules/farmdata2_modules:cached'
      - ./sampleDB:/sampleDB:cached  # Needed for building the db!
    ports:
      - '80:80'
    environment:
      XDEBUG_CONFIG: remote_host=172.17.0.1

  phpmyadmin:
    depends_on:
      - db
    image: farmdata2/phpmyadmin:fd2.1
    container_name: fd2_phpmyadmin
    environment:
      PMA_HOST: "db"
    ports:
      - 8181:80
    volumes:
      - /sessions
    links:
     - 'db'

  fd2dev:
    image: farmdata2/dev:fd2.1
    container_name: fd2_dev
    init: true
    volumes:
     - ..:/home/farmdev/FarmData2
     - ../farmdata2_modules:/home/farmdev/fd2test/farmdata2_modules
     - ../farmdata2_modules/cypress:/home/farmdev/fd2test/cypress
     - ../farmdata2_modules/cypress.config.js:/home/farmdev/fd2test/cypress.config.js
     - /var/run/docker.sock:/var/run/docker.sock
     - //var/run/docker.sock:/var/run/docker.sock  # for Windows hosts.
     - farmdev_home:/home/farmdev  # preserve home dir on volume.
     - farmos_db:/home/farmdev/FarmData2/docker/db
    ports:
     - 5901:5901
     - 6901:6901

volumes:
  farmdev_home:
  farmos_db:
